<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Personel Takip Pro</title>
<meta name="theme-color" content="#6366f1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUGVyc29uZWwgVGFraXAgUHJvIiwic2hvcnRfbmFtZSI6IlBUUyBQcm8iLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBhMGEwZiIsInRoZW1lX2NvbG9yIjoiIzYzNjZmMSJ9">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f0f14;--bg2:#16161e;--card:#1c1c27;--card2:#22222e;--border:#2d2d3a;--text:#f4f4f5;--muted:#8b8b9e;--accent:#818cf8;--accent2:#6366f1;--success:#34d399;--warning:#fbbf24;--danger:#f87171;--info:#38bdf8;--gradient:linear-gradient(135deg,#818cf8 0%,#6366f1 100%)}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--muted)}

/* Login */
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:radial-gradient(ellipse at top,#1a1a2e 0%,var(--bg) 70%)}
.login-box{background:var(--card);border:1px solid var(--border);border-radius:24px;padding:40px;width:100%;max-width:400px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.5)}
.logo{text-align:center;margin-bottom:32px}
.logo-icon{width:64px;height:64px;background:var(--gradient);border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:28px}
.logo h1{font-size:24px;font-weight:700;background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo p{color:var(--muted);font-size:13px;margin-top:4px}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:12px;font-weight:500;color:var(--muted);margin-bottom:6px}
.form-label.req::after{content:' *';color:var(--danger)}
input,select,textarea{width:100%;padding:12px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;transition:all .2s}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(129,140,248,.15)}
input::placeholder,textarea::placeholder{color:var(--muted)}
select{cursor:pointer}
select option{background:var(--bg2);color:var(--text)}
textarea{min-height:100px;resize:vertical}
.btn{padding:12px 20px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:all .2s}
.btn-primary{background:var(--gradient);color:#fff;width:100%}
.btn-primary:hover{opacity:.9;transform:translateY(-1px)}
.btn-success{background:var(--success);color:#000}
.btn-warning{background:var(--warning);color:#000}
.btn-danger{background:var(--danger);color:#fff}
.btn-ghost{background:var(--card2);color:var(--text)}
.btn-sm{padding:8px 14px;font-size:12px}
.btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.err{color:var(--danger);font-size:12px;margin-bottom:12px;padding:10px;background:rgba(248,113,113,.1);border-radius:8px}

/* Layout */
.layout{display:flex;min-height:100vh}
.sidebar{width:260px;background:var(--bg2);border-right:1px solid var(--border);position:fixed;height:100vh;display:flex;flex-direction:column;z-index:100;transition:transform .3s}
.side-header{padding:20px;border-bottom:1px solid var(--border)}
.side-brand{display:flex;align-items:center;gap:12px}
.side-brand-icon{width:40px;height:40px;background:var(--gradient);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
.side-brand h2{font-size:16px;font-weight:700}
.side-brand span{font-size:10px;color:var(--muted);display:block}
.firm-badge{background:var(--accent);color:#fff;padding:4px 10px;border-radius:6px;font-size:10px;font-weight:600;margin-top:8px;display:inline-block}
.firm-badge.master{background:var(--warning);color:#000}
.side-nav{flex:1;overflow-y:auto;padding:12px}
.nav-section{margin-bottom:8px}
.nav-title{font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;padding:12px 12px 8px}
.nav-item{display:flex;align-items:center;gap:10px;padding:11px 14px;border-radius:10px;color:var(--muted);cursor:pointer;font-size:13px;font-weight:500;margin-bottom:2px;transition:all .15s}
.nav-item:hover{background:var(--card);color:var(--text)}
.nav-item.active{background:rgba(129,140,248,.15);color:var(--accent)}
.nav-item svg{width:18px;height:18px;flex-shrink:0}
.nav-item .badge-count{margin-left:auto;background:var(--danger);color:#fff;font-size:10px;padding:2px 6px;border-radius:10px}
.side-footer{padding:16px;border-top:1px solid var(--border)}
.user-card{display:flex;align-items:center;gap:10px;padding:10px;background:var(--card);border-radius:12px;margin-bottom:10px}
.user-avatar{width:38px;height:38px;background:var(--gradient);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px}
.user-avatar.master{background:linear-gradient(135deg,#fbbf24,#f59e0b)}
.user-info h4{font-size:13px;font-weight:600}
.user-info p{font-size:11px;color:var(--muted)}
.logout-btn{width:100%;padding:10px;background:transparent;border:1px solid var(--border);border-radius:10px;color:var(--muted);font-size:12px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .15s}
.logout-btn:hover{background:var(--danger);border-color:var(--danger);color:#fff}

/* Mobile Menu */
.mobile-header{display:none;position:fixed;top:0;left:0;right:0;height:60px;background:var(--bg2);border-bottom:1px solid var(--border);z-index:99;padding:0 16px;align-items:center;justify-content:space-between}
.menu-toggle{background:none;border:none;color:var(--text);cursor:pointer;padding:8px}
.menu-toggle svg{width:24px;height:24px}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99}

/* Main */
.main{flex:1;margin-left:260px;padding:24px;min-height:100vh}
.page-header{margin-bottom:24px}
.page-header h1{font-size:26px;font-weight:700}
.page-header p{color:var(--muted);font-size:14px;margin-top:4px}
.page-actions{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}

/* Search Box */
.search-box{position:relative;margin-bottom:16px}
.search-box input{padding-left:40px}
.search-box svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);width:18px;height:18px;color:var(--muted)}
.search-box .clear-search{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;padding:4px;display:flex}
.search-box .clear-search:hover{color:var(--text)}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:12px}
.card-title{font-size:15px;font-weight:600;display:flex;align-items:center;gap:8px}
.card-title svg{width:18px;height:18px;color:var(--accent)}

/* Stats */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.stat-card.accent::before{background:var(--accent)}
.stat-card.success::before{background:var(--success)}
.stat-card.warning::before{background:var(--warning)}
.stat-card.danger::before{background:var(--danger)}
.stat-card.info::before{background:var(--info)}
.stat-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:12px}
.stat-icon.accent{background:rgba(129,140,248,.15);color:var(--accent)}
.stat-icon.success{background:rgba(52,211,153,.15);color:var(--success)}
.stat-icon.warning{background:rgba(251,191,36,.15);color:var(--warning)}
.stat-icon.danger{background:rgba(248,113,113,.15);color:var(--danger)}
.stat-icon.info{background:rgba(56,189,248,.15);color:var(--info)}
.stat-icon svg{width:22px;height:22px}
.stat-label{font-size:12px;color:var(--muted);font-weight:500;text-transform:uppercase;letter-spacing:.3px}
.stat-value{font-size:32px;font-weight:800;margin-top:4px}
.stat-change{font-size:11px;margin-top:6px;display:flex;align-items:center;gap:4px}
.stat-change.up{color:var(--success)}
.stat-change.down{color:var(--danger)}

/* Chart */
.chart-container{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px}
.chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.chart-title{font-size:15px;font-weight:600}
.chart-tabs{display:flex;gap:4px;background:var(--bg2);padding:4px;border-radius:8px}
.chart-tab{padding:6px 12px;font-size:11px;font-weight:500;color:var(--muted);cursor:pointer;border-radius:6px;transition:all .15s}
.chart-tab.active{background:var(--accent);color:#fff}
.chart-area{height:200px;display:flex;align-items:end;gap:8px;padding:10px 0}
.chart-bar{flex:1;background:var(--accent);border-radius:6px 6px 0 0;min-height:4px;transition:height .3s;position:relative}
.chart-bar:hover{background:var(--accent2)}
.chart-bar-label{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);font-size:9px;color:var(--muted);white-space:nowrap}
.chart-bar-value{position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:10px;font-weight:600;opacity:0;transition:opacity .15s}
.chart-bar:hover .chart-bar-value{opacity:1}

/* Table */
.table-wrap{overflow-x:auto;margin:-20px;padding:20px}
table{width:100%;border-collapse:collapse;min-width:600px}
th,td{padding:12px 14px;text-align:left;border-bottom:1px solid var(--border);font-size:13px}
th{color:var(--muted);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.3px;background:var(--bg2)}
th .th-help{display:block;font-weight:400;font-size:9px;text-transform:none;letter-spacing:0;margin-top:2px;opacity:.7}
tr:hover td{background:var(--card2)}
.badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;white-space:nowrap}
.badge-in{background:rgba(52,211,153,.15);color:var(--success)}
.badge-out{background:rgba(129,140,248,.15);color:var(--accent)}
.badge-break{background:rgba(251,191,36,.15);color:var(--warning)}
.badge-pending{background:rgba(251,191,36,.15);color:var(--warning)}
.badge-approved{background:rgba(52,211,153,.15);color:var(--success)}
.badge-rejected{background:rgba(248,113,113,.15);color:var(--danger)}
.badge-active{background:rgba(52,211,153,.15);color:var(--success)}
.badge-passive{background:rgba(248,113,113,.15);color:var(--danger)}

/* Toggle */
.toggle{position:relative;width:44px;height:24px;background:var(--border);border-radius:12px;cursor:pointer;transition:all .2s}
.toggle.active{background:var(--success)}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:10px;transition:all .2s}
.toggle.active::after{left:22px}
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)}
.toggle-row:last-child{border-bottom:none}
.toggle-info h4{font-size:14px;font-weight:500}
.toggle-info p{font-size:12px;color:var(--muted);margin-top:2px}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:200;padding:20px;backdrop-filter:blur(4px)}
.modal{background:var(--card);border:1px solid var(--border);border-radius:20px;width:100%;max-width:500px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
.modal-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-header h2{font-size:18px;font-weight:600}
.modal-close{background:none;border:none;color:var(--muted);cursor:pointer;padding:4px}
.modal-close:hover{color:var(--text)}
.modal-body{padding:20px;overflow-y:auto;flex:1}
.modal-footer{padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}

/* Empty State */
.empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
.empty-state svg{width:48px;height:48px;margin-bottom:12px;opacity:.5}
.empty-state h3{font-size:16px;color:var(--text);margin-bottom:4px}
.empty-state p{font-size:13px}

/* Action Buttons */
.action-btns{display:flex;gap:6px}
.action-btn{width:32px;height:32px;border:none;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.action-btn svg{width:16px;height:16px}
.action-btn.edit{background:rgba(129,140,248,.15);color:var(--accent)}
.action-btn.edit:hover{background:var(--accent);color:#fff}
.action-btn.delete{background:rgba(248,113,113,.15);color:var(--danger)}
.action-btn.delete:hover{background:var(--danger);color:#fff}
.action-btn.view{background:rgba(56,189,248,.15);color:var(--info)}
.action-btn.view:hover{background:var(--info);color:#fff}

/* Toast */
.toast-container{position:fixed;top:20px;right:20px;z-index:300;display:flex;flex-direction:column;gap:10px}
.toast{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 18px;display:flex;align-items:flex-start;gap:12px;min-width:280px;max-width:400px;box-shadow:0 10px 40px rgba(0,0,0,.3);animation:slideIn .3s ease}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.toast-icon{width:20px;height:20px;flex-shrink:0;margin-top:1px}
.toast.success .toast-icon{color:var(--success)}
.toast.error .toast-icon{color:var(--danger)}
.toast.warning .toast-icon{color:var(--warning)}
.toast.info .toast-icon{color:var(--info)}
.toast-content h4{font-size:13px;font-weight:600}
.toast-content p{font-size:12px;color:var(--muted);margin-top:2px}

/* Permission Grid */
.perm-grid{display:grid;gap:12px}
.perm-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px}
.perm-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.perm-card-title{font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px}
.perm-card-title svg{width:18px;height:18px;color:var(--accent)}
.perm-items{display:flex;flex-direction:column;gap:8px}
.perm-item{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--card);border-radius:8px}
.perm-item-label{font-size:13px}
.perm-item-desc{font-size:11px;color:var(--muted)}

/* Mobile Responsive */
@media(max-width:768px){
.mobile-header{display:flex}
.sidebar{transform:translateX(-100%)}
.sidebar.open{transform:translateX(0)}
.sidebar-overlay.show{display:block}
.main{margin-left:0;padding:80px 16px 24px}
.stats-grid{grid-template-columns:1fr 1fr}
.stat-value{font-size:24px}
.page-header h1{font-size:22px}
.modal{max-width:100%;margin:10px;border-radius:16px}
.toast-container{left:16px;right:16px}
.toast{min-width:auto;width:100%}
}
@media(max-width:480px){
.stats-grid{grid-template-columns:1fr}
.page-actions{flex-direction:column}
.page-actions .btn{width:100%}
}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script type="text/babel">
const {useState,useEffect,createContext,useContext,useCallback}=React;

// Supabase Config
const SUPABASE_URL='https://ynfcxrdpqcpcuntxrmgi.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InluZmN4cmRwcWNwY3VudHhybWdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzU5NTEsImV4cCI6MjA2Mjc1MTk1MX0.3bTn4WTJBslBNeuM6z0_RCBmjfR7SAF8242J3FKRJYc';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

// Toast Context
const ToastContext=createContext();
const useToast=()=>useContext(ToastContext);

function ToastProvider({children}){
const[toasts,setToasts]=useState([]);
const addToast=(type,title,message)=>{
const id=Date.now();
setToasts(p=>[...p,{id,type,title,message}]);
setTimeout(()=>setToasts(p=>p.filter(t=>t.id!==id)),4000);
};
return<ToastContext.Provider value={{addToast}}>{children}<div className="toast-container">{toasts.map(t=><Toast key={t.id} {...t}/>)}</div></ToastContext.Provider>;
}

function Toast({type,title,message}){
const icons={success:<Icon.CheckCircle/>,error:<Icon.XCircle/>,warning:<Icon.AlertTriangle/>,info:<Icon.Info/>};
return<div className={`toast ${type}`}><div className="toast-icon">{icons[type]}</div><div className="toast-content"><h4>{title}</h4><p>{message}</p></div></div>;
}

// Icons
const Icon={
Home:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>,
Users:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
Building:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 22V4c0-.27.2-.5.45-.56l10-2.22c.4-.1.8.18.8.56V22"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 22h2a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2h-2"/><path d="M10 6h4M10 10h4M10 14h4M10 18h4"/></svg>,
Clock:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>,
Calendar:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
FileText:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>,
Settings:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
LogOut:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
Plus:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
Edit:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
Trash:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
X:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
Check:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20,6 9,17 4,12"/></svg>,
CheckCircle:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22,4 12,14.01 9,11.01"/></svg>,
XCircle:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>,
AlertTriangle:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
Info:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
Mail:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>,
Send:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22,2 15,22 11,13 2,9 22,2"/></svg>,
MapPin:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
Eye:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
Menu:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
Search:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
Shield:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
Key:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>,
TrendingUp:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23,6 13.5,15.5 8.5,10.5 1,18"/><polyline points="17,6 23,6 23,12"/></svg>,
Activity:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/></svg>,
Coffee:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>,
LogIn:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10,17 15,12 10,7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>,
UserCheck:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17,11 19,13 23,9"/></svg>
};

// Roles
const ROLES={master:'S√ºper Admin',firma_admin:'Firma Admin',gm:'Genel M√ºd√ºr',mudur:'M√ºd√ºr',mudur_yrd:'M√ºd√ºr Yardƒ±mcƒ±sƒ±',sef:'≈ûef',personel:'Personel'};
const ROLE_LEVELS={master:100,firma_admin:90,gm:80,mudur:70,mudur_yrd:60,sef:50,personel:10};

// Shifts
const SHIFTS=[
{id:'sabah',name:'Sabah',icon:'üåÖ',start:'08:00',end:'16:00'},
{id:'aksam',name:'Ak≈üam',icon:'üåÜ',start:'16:00',end:'00:00'},
{id:'gece',name:'Gece',icon:'üåô',start:'00:00',end:'08:00'},
{id:'izin',name:'ƒ∞zinli',icon:'üèñÔ∏è',start:'-',end:'-'},
{id:'off',name:'Off',icon:'üò¥',start:'-',end:'-'}
];

// Default Permissions
const DEFAULT_PERMISSIONS={
gm:{dashboard:true,records:true,leaves:true,schedule:true,inbox:true,staff:true,sendMessage:true,reports:true},
mudur:{dashboard:true,records:true,leaves:true,schedule:true,inbox:true,staff:false,sendMessage:true,reports:true},
mudur_yrd:{dashboard:true,records:true,leaves:true,schedule:false,inbox:true,staff:false,sendMessage:false,reports:false},
sef:{dashboard:true,records:true,leaves:true,schedule:false,inbox:true,staff:false,sendMessage:false,reports:false},
personel:{dashboard:true,records:true,leaves:true,schedule:false,inbox:true,staff:false,sendMessage:false,reports:false}
};

const PERMISSION_LABELS={
dashboard:{name:'Dashboard',desc:'Ana paneli g√∂r√ºnt√ºleme'},
records:{name:'Puantaj',desc:'Giri≈ü/√ßƒ±kƒ±≈ü kayƒ±tlarƒ±nƒ± g√∂rme'},
leaves:{name:'ƒ∞zinler',desc:'ƒ∞zin taleplerini g√∂rme/olu≈üturma'},
schedule:{name:'Vardiya',desc:'Vardiya planlamasƒ±nƒ± g√∂rme'},
inbox:{name:'Mesajlar',desc:'Mesaj kutusunu g√∂rme'},
staff:{name:'Personel Y√∂netimi',desc:'Personel listesini g√∂rme/d√ºzenleme'},
sendMessage:{name:'Mesaj G√∂nderme',desc:'Personellere mesaj g√∂nderme'},
reports:{name:'Raporlar',desc:'Raporlarƒ± g√∂r√ºnt√ºleme'}
};

// App
function App(){
const[user,setUser]=useState(null);
const[loading,setLoading]=useState(true);
const[users,setUsers]=useState([]);
const[companies,setCompanies]=useState([]);
const[records,setRecords]=useState([]);
const[leaves,setLeaves]=useState([]);
const[shifts,setShifts]=useState([]);
const[messages,setMessages]=useState([]);
const[permissions,setPermissions]=useState({});

useEffect(()=>{
const saved=localStorage.getItem('pts_user');
if(saved){
try{setUser(JSON.parse(saved));}catch(e){localStorage.removeItem('pts_user');}
}
setLoading(false);
},[]);

useEffect(()=>{
if(user)loadData();
},[user]);

const loadData=async()=>{
const isMaster=user.role==='master';

// Users
let uq=supabase.from('users').select('*');
if(!isMaster)uq=uq.eq('company_id',user.cid);
const{data:ud}=await uq;
if(ud)setUsers(ud.map(u=>({id:u.id,email:u.email,name:u.full_name,role:u.role,cid:u.company_id,active:u.is_active,phone:u.phone,tc:u.tc_no,startDate:u.start_date})));

// Companies
if(isMaster){
const{data:cd}=await supabase.from('companies').select('*');
if(cd)setCompanies(cd.map(c=>({id:c.id,name:c.name,code:c.code,active:c.is_active,lat:c.lat,lng:c.lng,radius:c.radius,locationCheck:c.location_check})));
}else{
const{data:cd}=await supabase.from('companies').select('*').eq('id',user.cid);
if(cd&&cd[0])setCompanies([{id:cd[0].id,name:cd[0].name,code:cd[0].code,active:cd[0].is_active,lat:cd[0].lat,lng:cd[0].lng,radius:cd[0].radius,locationCheck:cd[0].location_check}]);
}

// Records
let rq=supabase.from('attendance_records').select('*').order('created_at',{ascending:false}).limit(500);
if(!isMaster)rq=rq.eq('company_id',user.cid);
const{data:rd}=await rq;
if(rd)setRecords(rd.map(r=>({id:r.id,uid:r.user_id,cid:r.company_id,type:r.type,time:r.created_at,lat:r.lat,lng:r.lng,note:r.note})));

// Leaves
let lq=supabase.from('leave_requests').select('*').order('created_at',{ascending:false});
if(!isMaster)lq=lq.eq('company_id',user.cid);
const{data:ld}=await lq;
if(ld)setLeaves(ld.map(l=>({id:l.id,uid:l.user_id,cid:l.company_id,type:l.leave_type,start:l.start_date,end:l.end_date,reason:l.reason,status:l.status,reviewer:l.reviewed_by,reviewDate:l.reviewed_at})));

// Shifts
let sq=supabase.from('shifts').select('*');
if(!isMaster)sq=sq.eq('company_id',user.cid);
const{data:sd}=await sq;
if(sd)setShifts(sd.map(s=>({id:s.id,uid:s.user_id,cid:s.company_id,date:s.date,shift:s.shift_type})));

// Messages
let mq=supabase.from('messages').select('*').order('created_at',{ascending:false});
if(!isMaster)mq=mq.eq('company_id',user.cid);
const{data:md}=await mq;
if(md)setMessages(md.map(m=>({id:m.id,from:m.from_id,to:m.to_id,cid:m.company_id,title:m.title,body:m.body,read:m.is_read,date:m.created_at})));

// Permissions
let pq=supabase.from('role_permissions').select('*');
if(!isMaster)pq=pq.eq('company_id',user.cid);
const{data:pd}=await pq;
if(pd){
const permMap={};
pd.forEach(p=>{
if(!permMap[p.company_id])permMap[p.company_id]={};
if(!permMap[p.company_id][p.role])permMap[p.company_id][p.role]={};
permMap[p.company_id][p.role][p.permission_key]=p.is_enabled;
});
setPermissions(permMap);
}
};

const login=(u)=>{localStorage.setItem('pts_user',JSON.stringify(u));setUser(u);};
const logout=()=>{localStorage.removeItem('pts_user');setUser(null);setUsers([]);setRecords([]);setLeaves([]);setShifts([]);setMessages([]);};

if(loading)return<div className="login-wrap"><div className="logo-icon" style={{animation:'pulse 1s infinite'}}>‚è≥</div></div>;
if(!user)return<ToastProvider><Login onLogin={login}/></ToastProvider>;

return(
<ToastProvider>
<MainApp user={user} logout={logout} users={users} setUsers={setUsers} companies={companies} setCompanies={setCompanies} records={records} setRecords={setRecords} leaves={leaves} setLeaves={setLeaves} shifts={shifts} setShifts={setShifts} messages={messages} setMessages={setMessages} permissions={permissions} setPermissions={setPermissions} roles={ROLES}/>
</ToastProvider>
);
}

// Login
function Login({onLogin}){
const toast=useToast();
const[email,setEmail]=useState('');
const[pass,setPass]=useState('');
const[err,setErr]=useState('');
const[loading,setLoading]=useState(false);

const handleLogin=async(e)=>{
e.preventDefault();
if(!email||!pass){setErr('T√ºm alanlarƒ± doldurun');return;}
setLoading(true);setErr('');

const{data,error}=await supabase.from('users').select('*,companies(*)').eq('email',email.toLowerCase().trim()).eq('password_hash',pass).single();
setLoading(false);

if(error||!data){setErr('Email veya ≈üifre hatalƒ±');return;}
if(!data.is_active){setErr('Hesabƒ±nƒ±z pasif durumda');return;}
if(data.company_id&&data.companies&&!data.companies.is_active){setErr('Firmanƒ±z pasif durumda');return;}

const u={id:data.id,email:data.email,name:data.full_name,role:data.role,cid:data.company_id,cname:data.companies?.name||'Master'};
toast.addToast('success','Ho≈ü geldin!',u.name);
onLogin(u);
};

return(
<div className="login-wrap">
<form className="login-box" onSubmit={handleLogin}>
<div className="logo">
<div className="logo-icon">üë•</div>
<h1>Personel Takip Pro</h1>
<p>Profesyonel personel y√∂netim sistemi</p>
</div>
{err&&<div className="err">{err}</div>}
<div className="form-group">
<label className="form-label">Email</label>
<input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="ornek@firma.com"/>
</div>
<div className="form-group">
<label className="form-label">≈ûifre</label>
<input type="password" value={pass} onChange={e=>setPass(e.target.value)} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
</div>
<button type="submit" className="btn btn-primary" disabled={loading}>{loading?'Giri≈ü yapƒ±lƒ±yor...':'Giri≈ü Yap'}</button>
</form>
</div>
);
}

// Main App
function MainApp({user:cu,logout,users,setUsers,companies,setCompanies,records,setRecords,leaves,setLeaves,shifts,setShifts,messages,setMessages,permissions,setPermissions,roles}){
const[page,setPage]=useState('dashboard');
const[sidebarOpen,setSidebarOpen]=useState(false);

const isMaster=cu.role==='master';
const isFirmaAdmin=cu.role==='firma_admin';
const isGM=cu.role==='gm';
const isManager=['gm','mudur','mudur_yrd','sef'].includes(cu.role);

// Get user's permissions
const getUserPermissions=useCallback(()=>{
if(isMaster||isFirmaAdmin)return null; // Full access
const companyPerms=permissions[cu.cid];
if(companyPerms&&companyPerms[cu.role]){
return{...DEFAULT_PERMISSIONS[cu.role],...companyPerms[cu.role]};
}
return DEFAULT_PERMISSIONS[cu.role]||{};
},[cu,permissions,isMaster,isFirmaAdmin]);

const userPerms=getUserPermissions();
const hasPermission=(key)=>{
if(isMaster||isFirmaAdmin)return true;
if(!userPerms)return true;
return userPerms[key]!==false;
};

const unreadCount=messages.filter(m=>(m.to===cu.id||(m.to===null&&m.cid===cu.cid))&&!m.read).length;

const navItems=[
{id:'dashboard',icon:<Icon.Home/>,label:'Dashboard',show:true},
{id:'records',icon:<Icon.Clock/>,label:'Puantaj',show:hasPermission('records')},
{id:'leaves',icon:<Icon.Calendar/>,label:'ƒ∞zinler',show:hasPermission('leaves')},
{id:'schedule',icon:<Icon.FileText/>,label:'Vardiya',show:isManager&&hasPermission('schedule')},
{id:'inbox',icon:<Icon.Mail/>,label:'Mesajlar',badge:unreadCount,show:hasPermission('inbox')},
{id:'sendMessage',icon:<Icon.Send/>,label:'Mesaj G√∂nder',show:isManager&&hasPermission('sendMessage')},
{id:'staff',icon:<Icon.Users/>,label:'Personeller',show:(isFirmaAdmin||isGM||hasPermission('staff'))},
{id:'companies',icon:<Icon.Building/>,label:'Firmalar',show:isMaster},
{id:'permissions',icon:<Icon.Shield/>,label:'Yetki Y√∂netimi',show:isFirmaAdmin},
{id:'settings',icon:<Icon.Settings/>,label:'Ayarlar',show:isFirmaAdmin||isMaster}
];

const closeSidebar=()=>setSidebarOpen(false);

return(
<div className="layout">
<div className="mobile-header">
<button className="menu-toggle" onClick={()=>setSidebarOpen(true)}><Icon.Menu/></button>
<span style={{fontWeight:600}}>Personel Takip Pro</span>
<div style={{width:40}}/>
</div>
<div className={`sidebar-overlay ${sidebarOpen?'show':''}`} onClick={closeSidebar}/>
<aside className={`sidebar ${sidebarOpen?'open':''}`}>
<div className="side-header">
<div className="side-brand">
<div className="side-brand-icon">üë•</div>
<div><h2>PTS Pro</h2><span>v2.0</span></div>
</div>
<div className={`firm-badge ${isMaster?'master':''}`}>{isMaster?'üîë MASTER':cu.cname}</div>
</div>
<nav className="side-nav">
<div className="nav-section">
<div className="nav-title">Ana Men√º</div>
{navItems.filter(n=>n.show).map(n=>(
<div key={n.id} className={`nav-item ${page===n.id?'active':''}`} onClick={()=>{setPage(n.id);closeSidebar();}}>
{n.icon}<span>{n.label}</span>{n.badge>0&&<span className="badge-count">{n.badge}</span>}
</div>
))}
</div>
</nav>
<div className="side-footer">
<div className="user-card">
<div className={`user-avatar ${isMaster?'master':''}`}>{cu.name.charAt(0)}</div>
<div className="user-info"><h4>{cu.name}</h4><p>{roles[cu.role]}</p></div>
</div>
<button className="logout-btn" onClick={logout}><Icon.LogOut/>√áƒ±kƒ±≈ü Yap</button>
</div>
</aside>
<main className="main">
{page==='dashboard'&&<Dashboard cu={cu} users={users} records={records} leaves={leaves} companies={companies}/>}
{page==='records'&&<Records cu={cu} users={users} records={records} setRecords={setRecords} companies={companies}/>}
{page==='leaves'&&<Leaves cu={cu} users={users} leaves={leaves} setLeaves={setLeaves} roles={roles}/>}
{page==='schedule'&&<Schedule cu={cu} users={users} shifts={shifts} setShifts={setShifts}/>}
{page==='inbox'&&<Inbox cu={cu} messages={messages} setMessages={setMessages} users={users}/>}
{page==='sendMessage'&&<SendMessage cu={cu} users={users} setMessages={setMessages} roles={roles}/>}
{page==='staff'&&<Staff cu={cu} users={users} setUsers={setUsers} companies={companies} roles={roles}/>}
{page==='companies'&&<Companies cu={cu} companies={companies} setCompanies={setCompanies}/>}
{page==='permissions'&&<PermissionManager cu={cu} permissions={permissions} setPermissions={setPermissions}/>}
{page==='settings'&&<Settings cu={cu} companies={companies} setCompanies={setCompanies}/>}
</main>
</div>
);
}

// Dashboard
function Dashboard({cu,users,records,leaves,companies}){
const isMaster=cu.role==='master';
const myCompany=companies.find(c=>c.id===cu.cid);

const today=new Date().toDateString();
const todayRecords=records.filter(r=>new Date(r.time).toDateString()===today);
const activeUsers=users.filter(u=>u.active).length;
const pendingLeaves=leaves.filter(l=>l.status==='pending').length;

const currentlyIn=new Set();
todayRecords.forEach(r=>{
if(r.type==='in')currentlyIn.add(r.uid);
else if(r.type==='out')currentlyIn.delete(r.uid);
});

// Weekly chart data
const weekData=[];
for(let i=6;i>=0;i--){
const d=new Date();d.setDate(d.getDate()-i);
const ds=d.toDateString();
const count=records.filter(r=>new Date(r.time).toDateString()===ds&&r.type==='in').length;
weekData.push({day:['Paz','Pzt','Sal','√áar','Per','Cum','Cmt'][d.getDay()],count});
}
const maxCount=Math.max(...weekData.map(w=>w.count),1);

return(
<div>
<div className="page-header">
<h1>Ho≈ü Geldin, {cu.name.split(' ')[0]}! üëã</h1>
<p>{new Date().toLocaleDateString('tr-TR',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</p>
</div>

<div className="stats-grid">
<div className="stat-card accent">
<div className="stat-icon accent"><Icon.Users/></div>
<div className="stat-label">Toplam Personel</div>
<div className="stat-value">{activeUsers}</div>
</div>
<div className="stat-card success">
<div className="stat-icon success"><Icon.UserCheck/></div>
<div className="stat-label">≈ûu An √áalƒ±≈üan</div>
<div className="stat-value">{currentlyIn.size}</div>
</div>
<div className="stat-card warning">
<div className="stat-icon warning"><Icon.Calendar/></div>
<div className="stat-label">Bekleyen ƒ∞zin</div>
<div className="stat-value">{pendingLeaves}</div>
</div>
<div className="stat-card info">
<div className="stat-icon info"><Icon.Activity/></div>
<div className="stat-label">Bug√ºn Hareket</div>
<div className="stat-value">{todayRecords.length}</div>
</div>
{isMaster&&<div className="stat-card danger">
<div className="stat-icon danger"><Icon.Building/></div>
<div className="stat-label">Aktif Firma</div>
<div className="stat-value">{companies.filter(c=>c.active).length}</div>
</div>}
</div>

<div className="chart-container">
<div className="chart-header">
<div className="chart-title">üìä Haftalƒ±k Giri≈ü Trendi</div>
</div>
<div className="chart-area">
{weekData.map((w,i)=>(
<div key={i} className="chart-bar" style={{height:`${(w.count/maxCount)*100}%`}}>
<div className="chart-bar-value">{w.count}</div>
<div className="chart-bar-label">{w.day}</div>
</div>
))}
</div>
</div>

<div className="card">
<div className="card-title"><Icon.Clock/>Son Hareketler</div>
<div className="table-wrap">
<table>
<thead><tr><th>Personel</th><th>ƒ∞≈ülem</th><th>Saat</th><th>Not</th></tr></thead>
<tbody>
{records.slice(0,10).map(r=>{
const u=users.find(x=>x.id===r.uid);
return<tr key={r.id}>
<td>{u?.name||'?'}</td>
<td><span className={`badge badge-${r.type==='in'?'in':r.type==='out'?'out':'break'}`}>{r.type==='in'?'Giri≈ü':r.type==='out'?'√áƒ±kƒ±≈ü':'Mola'}</span></td>
<td>{new Date(r.time).toLocaleString('tr-TR')}</td>
<td style={{color:'var(--muted)',fontSize:12}}>{r.note||'-'}</td>
</tr>;
})}
{records.length===0&&<tr><td colSpan="4" style={{textAlign:'center',color:'var(--muted)'}}>Hen√ºz kayƒ±t yok</td></tr>}
</tbody>
</table>
</div>
</div>
</div>
);
}

// Records (Puantaj)
function Records({cu,users,records,setRecords,companies}){
const toast=useToast();
const[loading,setLoading]=useState(false);
const myCompany=companies.find(c=>c.id===cu.cid);

const getStatus=()=>{
const today=new Date().toDateString();
const myToday=records.filter(r=>r.uid===cu.id&&new Date(r.time).toDateString()===today);
if(myToday.length===0)return'out';
const last=myToday[0];
return last.type;
};

const status=getStatus();

const clockAction=async(type)=>{
if(myCompany?.locationCheck){
if(!navigator.geolocation){
toast.addToast('error','Hata','Konum servisi desteklenmiyor');return;
}
setLoading(true);
navigator.geolocation.getCurrentPosition(async(pos)=>{
const{latitude:lat,longitude:lng}=pos.coords;
const dist=getDistance(lat,lng,myCompany.lat,myCompany.lng);
if(dist>myCompany.radius){
toast.addToast('error','Konum Hatasƒ±',`Firmadan ${Math.round(dist)}m uzaktasƒ±nƒ±z (max ${myCompany.radius}m)`);
setLoading(false);return;
}
await saveRecord(type,lat,lng);
},()=>{toast.addToast('error','Hata','Konum alƒ±namadƒ±');setLoading(false);});
}else{
setLoading(true);
await saveRecord(type,null,null);
}
};

const saveRecord=async(type,lat,lng)=>{
const{data,error}=await supabase.from('attendance_records').insert({user_id:cu.id,company_id:cu.cid,type,lat,lng}).select().single();
setLoading(false);
if(error){toast.addToast('error','Hata','Kayƒ±t yapƒ±lamadƒ±');return;}
setRecords(p=>[{id:data.id,uid:cu.id,cid:cu.cid,type,time:data.created_at,lat,lng},...p]);
toast.addToast('success','Ba≈üarƒ±lƒ±',type==='in'?'Giri≈ü yapƒ±ldƒ±':type==='out'?'√áƒ±kƒ±≈ü yapƒ±ldƒ±':'Mola ba≈üladƒ±');
};

const getDistance=(lat1,lng1,lat2,lng2)=>{
const R=6371e3;
const f1=lat1*Math.PI/180,f2=lat2*Math.PI/180;
const df=(lat2-lat1)*Math.PI/180,dl=(lng2-lng1)*Math.PI/180;
const a=Math.sin(df/2)**2+Math.cos(f1)*Math.cos(f2)*Math.sin(dl/2)**2;
return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
};

const myRecords=records.filter(r=>r.uid===cu.id);

return(
<div>
<div className="page-header">
<h1>Puantaj</h1>
<p>Giri≈ü/√ßƒ±kƒ±≈ü i≈ülemlerinizi yapƒ±n</p>
</div>

<div className="card" style={{textAlign:'center',padding:40}}>
<div style={{fontSize:64,marginBottom:16}}>{status==='in'?'üü¢':status==='break'?'üü°':'üî¥'}</div>
<h2 style={{marginBottom:8}}>{status==='in'?'√áalƒ±≈üƒ±yorsunuz':status==='break'?'Molada':'Mesai Dƒ±≈üƒ±'}</h2>
<p style={{color:'var(--muted)',marginBottom:24}}>{new Date().toLocaleTimeString('tr-TR')}</p>
<div style={{display:'flex',gap:12,justifyContent:'center',flexWrap:'wrap'}}>
<button className="btn btn-success" onClick={()=>clockAction('in')} disabled={loading||status==='in'}><Icon.LogIn/>Giri≈ü</button>
<button className="btn btn-warning" onClick={()=>clockAction('break')} disabled={loading||status!=='in'}><Icon.Coffee/>Mola</button>
<button className="btn btn-danger" onClick={()=>clockAction('out')} disabled={loading||status==='out'}><Icon.LogOut/>√áƒ±kƒ±≈ü</button>
</div>
{myCompany?.locationCheck&&<p style={{fontSize:11,color:'var(--muted)',marginTop:16}}>üìç Konum doƒürulamasƒ± aktif ({myCompany.radius}m)</p>}
</div>

<div className="card">
<div className="card-title"><Icon.Clock/>Kayƒ±tlarƒ±m</div>
<div className="table-wrap">
<table>
<thead><tr><th>Tarih</th><th>ƒ∞≈ülem</th><th>Saat</th></tr></thead>
<tbody>
{myRecords.slice(0,20).map(r=>(
<tr key={r.id}>
<td>{new Date(r.time).toLocaleDateString('tr-TR')}</td>
<td><span className={`badge badge-${r.type}`}>{r.type==='in'?'Giri≈ü':r.type==='out'?'√áƒ±kƒ±≈ü':'Mola'}</span></td>
<td>{new Date(r.time).toLocaleTimeString('tr-TR')}</td>
</tr>
))}
{myRecords.length===0&&<tr><td colSpan="3" style={{textAlign:'center',color:'var(--muted)'}}>Hen√ºz kayƒ±t yok</td></tr>}
</tbody>
</table>
</div>
</div>
</div>
);
}

// Leaves
function Leaves({cu,users,leaves,setLeaves,roles}){
const toast=useToast();
const[showModal,setShowModal]=useState(false);
const[form,setForm]=useState({type:'yillik',start:'',end:'',reason:''});
const[saving,setSaving]=useState(false);
const isManager=['master','firma_admin','gm','mudur'].includes(cu.role);

const leaveTypes={yillik:'Yƒ±llƒ±k ƒ∞zin',mazeret:'Mazeret ƒ∞zni',hastalik:'Hastalƒ±k ƒ∞zni',dogum:'Doƒüum ƒ∞zni',evlilik:'Evlilik ƒ∞zni',olum:'Vefat ƒ∞zni'};

const createLeave=async()=>{
if(!form.start||!form.end||!form.reason.trim()){toast.addToast('error','Hata','T√ºm alanlarƒ± doldurun');return;}
setSaving(true);
const{data,error}=await supabase.from('leave_requests').insert({user_id:cu.id,company_id:cu.cid,leave_type:form.type,start_date:form.start,end_date:form.end,reason:form.reason.trim(),status:'pending'}).select().single();
setSaving(false);
if(error){toast.addToast('error','Hata','ƒ∞stek g√∂nderilemedi');return;}
setLeaves(p=>[{id:data.id,uid:cu.id,cid:cu.cid,type:form.type,start:form.start,end:form.end,reason:form.reason.trim(),status:'pending'},...p]);
toast.addToast('success','Ba≈üarƒ±lƒ±','ƒ∞zin talebi g√∂nderildi');
setShowModal(false);setForm({type:'yillik',start:'',end:'',reason:''});
};

const updateStatus=async(id,status)=>{
const{error}=await supabase.from('leave_requests').update({status,reviewed_by:cu.id,reviewed_at:new Date().toISOString()}).eq('id',id);
if(!error){
setLeaves(p=>p.map(l=>l.id===id?{...l,status,reviewer:cu.id}:l));
toast.addToast('success','G√ºncellendi',status==='approved'?'ƒ∞zin onaylandƒ±':'ƒ∞zin reddedildi');
}
};

const myLeaves=leaves.filter(l=>l.uid===cu.id);
const pendingLeaves=isManager?leaves.filter(l=>l.status==='pending'&&l.uid!==cu.id):[];

return(
<div>
<div className="page-header">
<h1>ƒ∞zinler</h1>
<p>ƒ∞zin taleplerinizi y√∂netin</p>
<div className="page-actions">
<button className="btn btn-primary" onClick={()=>setShowModal(true)}><Icon.Plus/>Yeni ƒ∞zin Talebi</button>
</div>
</div>

{isManager&&pendingLeaves.length>0&&(
<div className="card">
<div className="card-title" style={{color:'var(--warning)'}}><Icon.AlertTriangle/>Bekleyen Talepler ({pendingLeaves.length})</div>
<div className="table-wrap">
<table>
<thead><tr><th>Personel</th><th>T√ºr</th><th>Tarih</th><th>Sebep</th><th>ƒ∞≈ülem</th></tr></thead>
<tbody>
{pendingLeaves.map(l=>{
const u=users.find(x=>x.id===l.uid);
return<tr key={l.id}>
<td>{u?.name||'?'}</td>
<td>{leaveTypes[l.type]}</td>
<td>{l.start} - {l.end}</td>
<td style={{maxWidth:200,overflow:'hidden',textOverflow:'ellipsis'}}>{l.reason}</td>
<td>
<div className="action-btns">
<button className="action-btn edit" title="Onayla" onClick={()=>updateStatus(l.id,'approved')}><Icon.Check/></button>
<button className="action-btn delete" title="Reddet" onClick={()=>updateStatus(l.id,'rejected')}><Icon.X/></button>
</div>
</td>
</tr>;
})}
</tbody>
</table>
</div>
</div>
)}

<div className="card">
<div className="card-title"><Icon.Calendar/>ƒ∞zin Taleplerim</div>
<div className="table-wrap">
<table>
<thead><tr><th>T√ºr</th><th>Ba≈ülangƒ±√ß</th><th>Biti≈ü</th><th>Durum</th></tr></thead>
<tbody>
{myLeaves.map(l=>(
<tr key={l.id}>
<td>{leaveTypes[l.type]}</td>
<td>{l.start}</td>
<td>{l.end}</td>
<td><span className={`badge badge-${l.status}`}>{l.status==='pending'?'Bekliyor':l.status==='approved'?'Onaylandƒ±':'Reddedildi'}</span></td>
</tr>
))}
{myLeaves.length===0&&<tr><td colSpan="4" style={{textAlign:'center',color:'var(--muted)'}}>Hen√ºz izin talebiniz yok</td></tr>}
</tbody>
</table>
</div>
</div>

{showModal&&<div className="modal-overlay" onClick={()=>setShowModal(false)}><div className="modal" onClick={e=>e.stopPropagation()}>
<div className="modal-header"><h2>Yeni ƒ∞zin Talebi</h2><button className="modal-close" onClick={()=>setShowModal(false)}><Icon.X/></button></div>
<div className="modal-body">
<div className="form-group">
<label className="form-label req">ƒ∞zin T√ºr√º</label>
<select value={form.type} onChange={e=>setForm({...form,type:e.target.value})}>
{Object.entries(leaveTypes).map(([k,v])=><option key={k} value={k}>{v}</option>)}
</select>
</div>
<div className="form-group">
<label className="form-label req">Ba≈ülangƒ±√ß</label>
<input type="date" value={form.start} onChange={e=>setForm({...form,start:e.target.value})}/>
</div>
<div className="form-group">
<label className="form-label req">Biti≈ü</label>
<input type="date" value={form.end} onChange={e=>setForm({...form,end:e.target.value})}/>
</div>
<div className="form-group">
<label className="form-label req">Sebep</label>
<textarea value={form.reason} onChange={e=>setForm({...form,reason:e.target.value})} placeholder="ƒ∞zin sebebinizi yazƒ±n..."/>
</div>
</div>
<div className="modal-footer">
<button className="btn btn-ghost" onClick={()=>setShowModal(false)}>ƒ∞ptal</button>
<button className="btn btn-primary" style={{width:'auto'}} onClick={createLeave} disabled={saving}>{saving?'G√∂nderiliyor...':'G√∂nder'}</button>
</div>
</div></div>}
</div>
);
}

// Schedule
function Schedule({cu,users,shifts,setShifts}){
const toast=useToast();
const[weekOffset,setWeekOffset]=useState(0);
const[saving,setSaving]=useState(false);

const getWeekDates=()=>{
const dates=[];
const today=new Date();
const monday=new Date(today);
monday.setDate(today.getDate()-today.getDay()+1+weekOffset*7);
for(let i=0;i<7;i++){
const d=new Date(monday);d.setDate(monday.getDate()+i);
dates.push(d.toISOString().split('T')[0]);
}
return dates;
};

const weekDates=getWeekDates();
const dayNames=['Pzt','Sal','√áar','Per','Cum','Cmt','Paz'];
const staff=users.filter(u=>u.cid===cu.cid&&u.active&&!['master','firma_admin'].includes(u.role));

const getShiftForUserDate=(uid,date)=>{
const s=shifts.find(x=>x.uid===uid&&x.date===date);
return s?.shift||'';
};

const setShift=async(uid,date,shift)=>{
setSaving(true);
const existing=shifts.find(x=>x.uid===uid&&x.date===date);
if(existing){
if(shift){
await supabase.from('shifts').update({shift_type:shift}).eq('id',existing.id);
setShifts(p=>p.map(s=>s.id===existing.id?{...s,shift}:s));
}else{
await supabase.from('shifts').delete().eq('id',existing.id);
setShifts(p=>p.filter(s=>s.id!==existing.id));
}
}else if(shift){
const{data}=await supabase.from('shifts').insert({user_id:uid,company_id:cu.cid,date,shift_type:shift}).select().single();
if(data)setShifts(p=>[...p,{id:data.id,uid,cid:cu.cid,date,shift}]);
}
setSaving(false);
};

const applyToAll=async(shiftType)=>{
setSaving(true);
for(const u of staff){
for(const date of weekDates){
await setShift(u.id,date,shiftType);
}
}
setSaving(false);
toast.addToast('success','Uygulandƒ±',`T√ºm personele ${SHIFTS.find(s=>s.id===shiftType)?.name} vardiyasƒ± atandƒ±`);
};

return(
<div>
<div className="page-header">
<h1>Vardiya Planƒ±</h1>
<p>Haftalƒ±k vardiya planlamasƒ±</p>
</div>

<div className="card">
<div className="card-header">
<div style={{display:'flex',alignItems:'center',gap:12}}>
<button className="btn btn-ghost btn-sm" onClick={()=>setWeekOffset(p=>p-1)}>‚Üê √ñnceki</button>
<span style={{fontWeight:600}}>{weekDates[0]} - {weekDates[6]}</span>
<button className="btn btn-ghost btn-sm" onClick={()=>setWeekOffset(p=>p+1)}>Sonraki ‚Üí</button>
</div>
<button className="btn btn-ghost btn-sm" onClick={()=>setWeekOffset(0)}>Bu Hafta</button>
</div>
</div>

<div className="card">
<div className="card-title">Toplu Atama</div>
<div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
{SHIFTS.map(s=><button key={s.id} className="btn btn-ghost btn-sm" onClick={()=>applyToAll(s.id)} disabled={saving}>{s.icon} Herkese {s.name}</button>)}
</div>
</div>

<div className="card" style={{overflowX:'auto'}}>
<table>
<thead><tr><th>Personel</th>{dayNames.map((d,i)=><th key={i} style={{textAlign:'center',minWidth:100}}>{d}<br/><span style={{fontSize:10,fontWeight:400}}>{weekDates[i]}</span></th>)}</tr></thead>
<tbody>
{staff.map(u=><tr key={u.id}>
<td><b>{u.name}</b></td>
{weekDates.map((date,i)=><td key={i} style={{padding:4}}>
<select value={getShiftForUserDate(u.id,date)} onChange={e=>setShift(u.id,date,e.target.value)} style={{padding:6,fontSize:11,minWidth:80}} disabled={saving}>
<option value="">-</option>
{SHIFTS.map(s=><option key={s.id} value={s.id}>{s.icon} {s.name}</option>)}
</select>
</td>)}
</tr>)}
{staff.length===0&&<tr><td colSpan="8" style={{textAlign:'center',color:'var(--muted)'}}>Personel bulunamadƒ±</td></tr>}
</tbody>
</table>
</div>
</div>
);
}

// Inbox
function Inbox({cu,messages,setMessages,users}){
const[selected,setSelected]=useState(null);

const markRead=async(id)=>{
await supabase.from('messages').update({is_read:true}).eq('id',id);
setMessages(p=>p.map(m=>m.id===id?{...m,read:true}:m));
};

const myMessages=messages.filter(m=>m.to===cu.id||(m.to===null&&m.cid===cu.cid));

return(
<div>
<div className="page-header"><h1>Mesajlar</h1><p>Gelen mesajlarƒ±nƒ±z</p></div>
<div className="card">
{myMessages.length===0?<div className="empty-state"><Icon.Mail/><h3>Mesaj Yok</h3><p>Hen√ºz mesajƒ±nƒ±z bulunmuyor</p></div>:
<div>
{myMessages.map(m=>{
const sender=users.find(u=>u.id===m.from);
return<div key={m.id} style={{padding:14,borderBottom:'1px solid var(--border)',cursor:'pointer',background:!m.read?'rgba(129,140,248,.05)':'transparent'}} onClick={()=>{setSelected(m);if(!m.read)markRead(m.id);}}>
<div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
<div>
<b style={{fontSize:14}}>{m.title}</b>
{!m.read&&<span className="badge badge-pending" style={{marginLeft:8}}>Yeni</span>}
{m.to===null&&<span className="badge badge-approved" style={{marginLeft:8}}>Toplu</span>}
</div>
<span style={{fontSize:11,color:'var(--muted)'}}>{new Date(m.date).toLocaleDateString('tr-TR')}</span>
</div>
<p style={{fontSize:12,color:'var(--muted)',marginTop:4}}>G√∂nderen: {sender?sender.name:'Sistem'}</p>
</div>;
})}
</div>}
</div>
{selected&&<div className="modal-overlay" onClick={()=>setSelected(null)}><div className="modal" onClick={e=>e.stopPropagation()}>
<div className="modal-header"><h2>{selected.title}</h2><button className="modal-close" onClick={()=>setSelected(null)}><Icon.X/></button></div>
<div className="modal-body">
<p style={{fontSize:12,color:'var(--muted)',marginBottom:16}}>G√∂nderen: {users.find(u=>u.id===selected.from)?.name||'Sistem'} ‚Ä¢ {new Date(selected.date).toLocaleString('tr-TR')}</p>
<p style={{whiteSpace:'pre-wrap'}}>{selected.body}</p>
</div>
<div className="modal-footer"><button className="btn btn-ghost" onClick={()=>setSelected(null)}>Kapat</button></div>
</div></div>}
</div>
);
}

// Send Message
function SendMessage({cu,users,setMessages,roles}){
const toast=useToast();
const[mode,setMode]=useState('single');
const[to,setTo]=useState('');
const[title,setTitle]=useState('');
const[body,setBody]=useState('');
const[saving,setSaving]=useState(false);

const staff=users.filter(x=>x.active&&!['master','firma_admin','gm'].includes(x.role));

const send=async()=>{
if(!title.trim()||!body.trim())return;
if(mode==='single'&&!to)return;
setSaving(true);
const msg={from_id:cu.id,to_id:mode==='all'?null:to,company_id:cu.cid,title:title.trim(),body:body.trim(),is_read:false};
const{data,error}=await supabase.from('messages').insert(msg).select().single();
setSaving(false);
if(!error){
setMessages(p=>[{id:data.id,from:cu.id,to:mode==='all'?null:to,cid:cu.cid,title:title.trim(),body:body.trim(),read:false,date:data.created_at},...p]);
toast.addToast('success','G√∂nderildi',mode==='all'?'Toplu mesaj g√∂nderildi':'Mesaj g√∂nderildi');
setTitle('');setBody('');setTo('');
}
};

return(
<div>
<div className="page-header"><h1>Mesaj G√∂nder</h1><p>Personellere mesaj g√∂nderin</p></div>
<div className="card" style={{maxWidth:600}}>
<div style={{display:'flex',gap:8,marginBottom:20}}>
<button className="btn btn-sm" style={{background:mode==='single'?'var(--accent)':'var(--card2)',color:mode==='single'?'#fff':'var(--text)'}} onClick={()=>setMode('single')}>Ki≈üiye √ñzel</button>
<button className="btn btn-sm" style={{background:mode==='all'?'var(--accent)':'var(--card2)',color:mode==='all'?'#fff':'var(--text)'}} onClick={()=>setMode('all')}>Toplu Mesaj</button>
</div>
{mode==='single'&&<div className="form-group">
<label className="form-label req">Alƒ±cƒ±</label>
<select value={to} onChange={e=>setTo(e.target.value)}>
<option value="">Se√ßin...</option>
{staff.map(u=><option key={u.id} value={u.id}>{u.name} ({roles[u.role]})</option>)}
</select>
</div>}
{mode==='all'&&<div style={{padding:12,background:'rgba(129,140,248,.1)',borderRadius:8,marginBottom:16}}><p style={{fontSize:13}}>üì¢ Bu mesaj firmadaki t√ºm personele g√∂nderilecek ({staff.length} ki≈üi)</p></div>}
<div className="form-group">
<label className="form-label req">Ba≈ülƒ±k</label>
<input value={title} onChange={e=>setTitle(e.target.value)} placeholder="Mesaj ba≈ülƒ±ƒüƒ±"/>
</div>
<div className="form-group">
<label className="form-label req">Mesaj</label>
<textarea value={body} onChange={e=>setBody(e.target.value)} placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." style={{minHeight:150}}/>
</div>
<button className="btn btn-primary" onClick={send} disabled={saving||!title.trim()||!body.trim()||(mode==='single'&&!to)}>{saving?'G√∂nderiliyor...':'G√∂nder'}</button>
</div>
</div>
);
}

// Staff (with Search)
function Staff({cu,users,setUsers,companies,roles}){
const toast=useToast();
const[showModal,setShowModal]=useState(false);
const[editUser,setEditUser]=useState(null);
const[form,setForm]=useState({name:'',email:'',password:'',role:'personel',phone:'',tc:'',cid:cu.cid});
const[saving,setSaving]=useState(false);
const[search,setSearch]=useState('');

const isMaster=cu.role==='master';
const isFirmaAdmin=cu.role==='firma_admin';

const myUsers=users.filter(u=>{
if(isMaster)return true;
return u.cid===cu.cid;
});

const filteredUsers=myUsers.filter(u=>{
if(!search.trim())return true;
const s=search.toLowerCase();
return u.name?.toLowerCase().includes(s)||u.email?.toLowerCase().includes(s)||u.phone?.includes(s)||roles[u.role]?.toLowerCase().includes(s);
});

const availableRoles=isMaster?Object.keys(ROLES):Object.keys(ROLES).filter(r=>ROLE_LEVELS[r]<ROLE_LEVELS[cu.role]);

const openNew=()=>{
setEditUser(null);
setForm({name:'',email:'',password:'',role:'personel',phone:'',tc:'',cid:cu.cid});
setShowModal(true);
};

const openEdit=(u)=>{
setEditUser(u);
setForm({name:u.name,email:u.email,password:'',role:u.role,phone:u.phone||'',tc:u.tc||'',cid:u.cid});
setShowModal(true);
};

const save=async()=>{
if(!form.name.trim()||!form.email.trim()||(!editUser&&!form.password)){
toast.addToast('error','Hata','Gerekli alanlarƒ± doldurun');return;
}
setSaving(true);

if(editUser){
const upd={full_name:form.name.trim(),email:form.email.toLowerCase().trim(),role:form.role,phone:form.phone,tc_no:form.tc,company_id:form.cid};
if(form.password)upd.password_hash=form.password;
const{error}=await supabase.from('users').update(upd).eq('id',editUser.id);
setSaving(false);
if(error){toast.addToast('error','Hata','G√ºncellenemedi');return;}
setUsers(p=>p.map(u=>u.id===editUser.id?{...u,name:form.name.trim(),email:form.email.toLowerCase().trim(),role:form.role,phone:form.phone,tc:form.tc,cid:form.cid}:u));
toast.addToast('success','G√ºncellendi','Kullanƒ±cƒ± g√ºncellendi');
}else{
const{data,error}=await supabase.from('users').insert({full_name:form.name.trim(),email:form.email.toLowerCase().trim(),password_hash:form.password,role:form.role,phone:form.phone,tc_no:form.tc,company_id:form.cid,is_active:true}).select().single();
setSaving(false);
if(error){toast.addToast('error','Hata',error.message.includes('duplicate')?'Bu email zaten kayƒ±tlƒ±':'Eklenemedi');return;}
setUsers(p=>[...p,{id:data.id,email:data.email,name:data.full_name,role:data.role,cid:data.company_id,active:true,phone:data.phone,tc:data.tc_no}]);
toast.addToast('success','Eklendi','Yeni kullanƒ±cƒ± olu≈üturuldu');
}
setShowModal(false);
};

const toggleActive=async(u)=>{
const{error}=await supabase.from('users').update({is_active:!u.active}).eq('id',u.id);
if(!error){
setUsers(p=>p.map(x=>x.id===u.id?{...x,active:!x.active}:x));
toast.addToast('success','G√ºncellendi',u.active?'Kullanƒ±cƒ± pasife alƒ±ndƒ±':'Kullanƒ±cƒ± aktif edildi');
}
};

return(
<div>
<div className="page-header">
<h1>Personeller</h1>
<p>Personel listesi ve y√∂netimi</p>
<div className="page-actions">
<button className="btn btn-primary" onClick={openNew}><Icon.Plus/>Yeni Personel</button>
</div>
</div>

<div className="card">
<div className="search-box">
<Icon.Search/>
<input placeholder="ƒ∞sim, email, telefon veya rol ile ara..." value={search} onChange={e=>setSearch(e.target.value)}/>
{search&&<button className="clear-search" onClick={()=>setSearch('')}><Icon.X/></button>}
</div>

<div className="table-wrap">
<table>
<thead><tr><th>Ad Soyad</th><th>Email</th><th>Rol</th>{isMaster&&<th>Firma</th>}<th>Durum</th><th>ƒ∞≈ülem</th></tr></thead>
<tbody>
{filteredUsers.map(u=>(
<tr key={u.id}>
<td><b>{u.name}</b></td>
<td>{u.email}</td>
<td>{roles[u.role]}</td>
{isMaster&&<td>{companies.find(c=>c.id===u.cid)?.name||'-'}</td>}
<td><span className={`badge badge-${u.active?'active':'passive'}`}>{u.active?'Aktif':'Pasif'}</span></td>
<td>
<div className="action-btns">
<button className="action-btn edit" onClick={()=>openEdit(u)}><Icon.Edit/></button>
<button className="action-btn delete" onClick={()=>toggleActive(u)}>{u.active?<Icon.X/>:<Icon.Check/>}</button>
</div>
</td>
</tr>
))}
{filteredUsers.length===0&&<tr><td colSpan={isMaster?6:5} style={{textAlign:'center',color:'var(--muted)'}}>{search?'Sonu√ß bulunamadƒ±':'Hen√ºz personel yok'}</td></tr>}
</tbody>
</table>
</div>
<div style={{marginTop:12,fontSize:12,color:'var(--muted)'}}>Toplam: {filteredUsers.length} personel {search&&`(${myUsers.length} i√ßinden)`}</div>
</div>

{showModal&&<div className="modal-overlay" onClick={()=>setShowModal(false)}><div className="modal" onClick={e=>e.stopPropagation()}>
<div className="modal-header"><h2>{editUser?'Personel D√ºzenle':'Yeni Personel'}</h2><button className="modal-close" onClick={()=>setShowModal(false)}><Icon.X/></button></div>
<div className="modal-body">
<div className="form-group">
<label className="form-label req">Ad Soyad</label>
<input value={form.name} onChange={e=>setForm({...form,name:e.target.value})} placeholder="Ahmet Yƒ±lmaz"/>
</div>
<div className="form-group">
<label className="form-label req">Email</label>
<input type="email" value={form.email} onChange={e=>setForm({...form,email:e.target.value})} placeholder="ahmet@firma.com"/>
</div>
<div className="form-group">
<label className={`form-label ${!editUser?'req':''}`}>{editUser?'Yeni ≈ûifre (bo≈ü bƒ±rakƒ±labilir)':'≈ûifre'}</label>
<input type="password" value={form.password} onChange={e=>setForm({...form,password:e.target.value})} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
</div>
<div className="form-group">
<label className="form-label req">Rol</label>
<select value={form.role} onChange={e=>setForm({...form,role:e.target.value})}>
{availableRoles.map(r=><option key={r} value={r}>{roles[r]}</option>)}
</select>
</div>
{isMaster&&<div className="form-group">
<label className="form-label req">Firma</label>
<select value={form.cid} onChange={e=>setForm({...form,cid:e.target.value})}>
<option value="">Se√ßin...</option>
{companies.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
</select>
</div>}
<div className="form-group">
<label className="form-label">Telefon</label>
<input value={form.phone} onChange={e=>setForm({...form,phone:e.target.value})} placeholder="05XX XXX XX XX"/>
</div>
<div className="form-group">
<label className="form-label">TC Kimlik No</label>
<input value={form.tc} onChange={e=>setForm({...form,tc:e.target.value})} placeholder="XXXXXXXXXXX"/>
</div>
</div>
<div className="modal-footer">
<button className="btn btn-ghost" onClick={()=>setShowModal(false)}>ƒ∞ptal</button>
<button className="btn btn-primary" style={{width:'auto'}} onClick={save} disabled={saving}>{saving?'Kaydediliyor...':'Kaydet'}</button>
</div>
</div></div>}
</div>
);
}

// Companies (with Search & Location Toggle)
function Companies({cu,companies,setCompanies}){
const toast=useToast();
const[showModal,setShowModal]=useState(false);
const[editCompany,setEditCompany]=useState(null);
const[form,setForm]=useState({name:'',code:'',lat:'',lng:'',radius:'100',locationCheck:false});
const[saving,setSaving]=useState(false);
const[search,setSearch]=useState('');

const filteredCompanies=companies.filter(c=>{
if(!search.trim())return true;
const s=search.toLowerCase();
return c.name?.toLowerCase().includes(s)||c.code?.toLowerCase().includes(s);
});

const openNew=()=>{
setEditCompany(null);
setForm({name:'',code:'',lat:'',lng:'',radius:'100',locationCheck:false});
setShowModal(true);
};

const openEdit=(c)=>{
setEditCompany(c);
setForm({name:c.name,code:c.code||'',lat:c.lat?.toString()||'',lng:c.lng?.toString()||'',radius:c.radius?.toString()||'100',locationCheck:c.locationCheck||false});
setShowModal(true);
};

const save=async()=>{
if(!form.name.trim()){toast.addToast('error','Hata','Firma adƒ± gerekli');return;}
setSaving(true);

const data={name:form.name.trim(),code:form.code.trim()||null,lat:form.lat?parseFloat(form.lat):null,lng:form.lng?parseFloat(form.lng):null,radius:parseInt(form.radius)||100,location_check:form.locationCheck};

if(editCompany){
const{error}=await supabase.from('companies').update(data).eq('id',editCompany.id);
setSaving(false);
if(error){toast.addToast('error','Hata','G√ºncellenemedi');return;}
setCompanies(p=>p.map(c=>c.id===editCompany.id?{...c,name:data.name,code:data.code,lat:data.lat,lng:data.lng,radius:data.radius,locationCheck:data.location_check}:c));
toast.addToast('success','G√ºncellendi','Firma g√ºncellendi');
}else{
const{data:d,error}=await supabase.from('companies').insert({...data,is_active:true}).select().single();
setSaving(false);
if(error){toast.addToast('error','Hata','Eklenemedi');return;}
setCompanies(p=>[...p,{id:d.id,name:d.name,code:d.code,active:true,lat:d.lat,lng:d.lng,radius:d.radius,locationCheck:d.location_check}]);
toast.addToast('success','Eklendi','Yeni firma olu≈üturuldu');
}
setShowModal(false);
};

const toggleActive=async(c)=>{
const{error}=await supabase.from('companies').update({is_active:!c.active}).eq('id',c.id);
if(!error){
setCompanies(p=>p.map(x=>x.id===c.id?{...x,active:!x.active}:x));
toast.addToast('success','G√ºncellendi',c.active?'Firma pasife alƒ±ndƒ±':'Firma aktif edildi');
}
};

const toggleLocationCheck=async(c)=>{
const{error}=await supabase.from('companies').update({location_check:!c.locationCheck}).eq('id',c.id);
if(!error){
setCompanies(p=>p.map(x=>x.id===c.id?{...x,locationCheck:!x.locationCheck}:x));
toast.addToast('success','G√ºncellendi',!c.locationCheck?'Konum doƒürulama a√ßƒ±ldƒ±':'Konum doƒürulama kapatƒ±ldƒ±');
}
};

return(
<div>
<div className="page-header">
<h1>Firmalar</h1>
<p>Firma listesi ve y√∂netimi</p>
<div className="page-actions">
<button className="btn btn-primary" onClick={openNew}><Icon.Plus/>Yeni Firma</button>
</div>
</div>

<div className="card">
<div className="search-box">
<Icon.Search/>
<input placeholder="Firma adƒ± veya kodu ile ara..." value={search} onChange={e=>setSearch(e.target.value)}/>
{search&&<button className="clear-search" onClick={()=>setSearch('')}><Icon.X/></button>}
</div>

<div className="table-wrap">
<table>
<thead>
<tr>
<th>Firma Adƒ±<span className="th-help">≈ûirketin resmi adƒ±</span></th>
<th>Kod<span className="th-help">Kƒ±sa tanƒ±mlama kodu</span></th>
<th>Konum<span className="th-help">Enlem / Boylam koordinatlarƒ±</span></th>
<th>Yarƒ±√ßap<span className="th-help">Giri≈ü yapƒ±labilecek max mesafe (m)</span></th>
<th>Konum Doƒürulama<span className="th-help">Personel giri≈üinde GPS kontrol√º</span></th>
<th>Durum<span className="th-help">Firma aktif/pasif durumu</span></th>
<th>ƒ∞≈ülem</th>
</tr>
</thead>
<tbody>
{filteredCompanies.map(c=>(
<tr key={c.id}>
<td><b>{c.name}</b></td>
<td>{c.code||'-'}</td>
<td style={{fontSize:11}}>{c.lat&&c.lng?`${c.lat}, ${c.lng}`:'-'}</td>
<td>{c.radius||100}m</td>
<td>
<div className={`toggle ${c.locationCheck?'active':''}`} onClick={()=>toggleLocationCheck(c)}/>
</td>
<td><span className={`badge badge-${c.active?'active':'passive'}`}>{c.active?'Aktif':'Pasif'}</span></td>
<td>
<div className="action-btns">
<button className="action-btn edit" onClick={()=>openEdit(c)}><Icon.Edit/></button>
<button className="action-btn delete" onClick={()=>toggleActive(c)}>{c.active?<Icon.X/>:<Icon.Check/>}</button>
</div>
</td>
</tr>
))}
{filteredCompanies.length===0&&<tr><td colSpan="7" style={{textAlign:'center',color:'var(--muted)'}}>{search?'Sonu√ß bulunamadƒ±':'Hen√ºz firma yok'}</td></tr>}
</tbody>
</table>
</div>
<div style={{marginTop:12,fontSize:12,color:'var(--muted)'}}>Toplam: {filteredCompanies.length} firma {search&&`(${companies.length} i√ßinden)`}</div>
</div>

{showModal&&<div className="modal-overlay" onClick={()=>setShowModal(false)}><div className="modal" onClick={e=>e.stopPropagation()}>
<div className="modal-header"><h2>{editCompany?'Firma D√ºzenle':'Yeni Firma'}</h2><button className="modal-close" onClick={()=>setShowModal(false)}><Icon.X/></button></div>
<div className="modal-body">
<div className="form-group">
<label className="form-label req">Firma Adƒ±</label>
<input value={form.name} onChange={e=>setForm({...form,name:e.target.value})} placeholder="ABC ≈ûirketi"/>
</div>
<div className="form-group">
<label className="form-label">Firma Kodu</label>
<input value={form.code} onChange={e=>setForm({...form,code:e.target.value})} placeholder="ABC"/>
</div>
<div style={{padding:16,background:'var(--bg2)',borderRadius:12,marginBottom:16}}>
<h4 style={{fontSize:14,marginBottom:12,display:'flex',alignItems:'center',gap:8}}><Icon.MapPin/>Konum Ayarlarƒ±</h4>
<div className="toggle-row">
<div className="toggle-info">
<h4>Konum Doƒürulama</h4>
<p>Personel giri≈ü/√ßƒ±kƒ±≈ülarƒ±nda GPS kontrol√º yapƒ±lsƒ±n</p>
</div>
<div className={`toggle ${form.locationCheck?'active':''}`} onClick={()=>setForm({...form,locationCheck:!form.locationCheck})}/>
</div>
{form.locationCheck&&<>
<div className="form-group" style={{marginTop:12,marginBottom:12}}>
<label className="form-label">Enlem (Latitude)</label>
<input type="number" step="any" value={form.lat} onChange={e=>setForm({...form,lat:e.target.value})} placeholder="40.7128"/>
</div>
<div className="form-group" style={{marginBottom:12}}>
<label className="form-label">Boylam (Longitude)</label>
<input type="number" step="any" value={form.lng} onChange={e=>setForm({...form,lng:e.target.value})} placeholder="29.0060"/>
</div>
<div className="form-group" style={{marginBottom:0}}>
<label className="form-label">Yarƒ±√ßap (metre)</label>
<input type="number" value={form.radius} onChange={e=>setForm({...form,radius:e.target.value})} placeholder="100"/>
</div>
</>}
</div>
</div>
<div className="modal-footer">
<button className="btn btn-ghost" onClick={()=>setShowModal(false)}>ƒ∞ptal</button>
<button className="btn btn-primary" style={{width:'auto'}} onClick={save} disabled={saving}>{saving?'Kaydediliyor...':'Kaydet'}</button>
</div>
</div></div>}
</div>
);
}

// Permission Manager (for Firma Admin)
function PermissionManager({cu,permissions,setPermissions}){
const toast=useToast();
const[saving,setSaving]=useState(false);
const[localPerms,setLocalPerms]=useState({});

const editableRoles=['gm','mudur','mudur_yrd','sef','personel'];

useEffect(()=>{
const companyPerms=permissions[cu.cid]||{};
const merged={};
editableRoles.forEach(role=>{
merged[role]={...DEFAULT_PERMISSIONS[role],...(companyPerms[role]||{})};
});
setLocalPerms(merged);
},[permissions,cu.cid]);

const togglePerm=(role,key)=>{
setLocalPerms(p=>({
...p,
[role]:{...p[role],[key]:!p[role][key]}
}));
};

const savePermissions=async()=>{
setSaving(true);

// Delete existing permissions for this company
await supabase.from('role_permissions').delete().eq('company_id',cu.cid);

// Insert new permissions
const inserts=[];
editableRoles.forEach(role=>{
Object.keys(PERMISSION_LABELS).forEach(key=>{
inserts.push({
company_id:cu.cid,
role,
permission_key:key,
is_enabled:localPerms[role]?.[key]??DEFAULT_PERMISSIONS[role]?.[key]??false
});
});
});

const{error}=await supabase.from('role_permissions').insert(inserts);
setSaving(false);

if(error){
toast.addToast('error','Hata','Yetkiler kaydedilemedi');
return;
}

// Update local state
const newPerms={...permissions};
newPerms[cu.cid]={...localPerms};
setPermissions(newPerms);

toast.addToast('success','Kaydedildi','Yetkiler g√ºncellendi');
};

const resetToDefault=()=>{
const merged={};
editableRoles.forEach(role=>{
merged[role]={...DEFAULT_PERMISSIONS[role]};
});
setLocalPerms(merged);
toast.addToast('info','Sƒ±fƒ±rlandƒ±','Varsayƒ±lan yetkiler y√ºklendi');
};

return(
<div>
<div className="page-header">
<h1>Yetki Y√∂netimi</h1>
<p>Rollere g√∂re √∂zellik eri≈üimlerini y√∂netin</p>
<div className="page-actions">
<button className="btn btn-ghost" onClick={resetToDefault}>Varsayƒ±lana Sƒ±fƒ±rla</button>
<button className="btn btn-primary" onClick={savePermissions} disabled={saving}>{saving?'Kaydediliyor...':'Deƒüi≈üiklikleri Kaydet'}</button>
</div>
</div>

<div className="card" style={{background:'rgba(129,140,248,.1)',border:'1px solid var(--accent)'}}>
<p style={{fontSize:13}}>üí° <b>ƒ∞pucu:</b> Bu sayfada her rol i√ßin hangi √∂zelliklere eri≈üim izni verileceƒüini belirleyebilirsiniz. Deƒüi≈üiklikler "Deƒüi≈üiklikleri Kaydet" butonuna basƒ±ldƒ±ƒüƒ±nda uygulanƒ±r.</p>
</div>

<div className="perm-grid">
{editableRoles.map(role=>(
<div key={role} className="perm-card">
<div className="perm-card-header">
<div className="perm-card-title"><Icon.Shield/>{ROLES[role]}</div>
</div>
<div className="perm-items">
{Object.entries(PERMISSION_LABELS).map(([key,{name,desc}])=>(
<div key={key} className="perm-item">
<div>
<div className="perm-item-label">{name}</div>
<div className="perm-item-desc">{desc}</div>
</div>
<div className={`toggle ${localPerms[role]?.[key]?'active':''}`} onClick={()=>togglePerm(role,key)}/>
</div>
))}
</div>
</div>
))}
</div>
</div>
);
}

// Settings
function Settings({cu,companies,setCompanies}){
const toast=useToast();
const isMaster=cu.role==='master';
const myCompany=companies.find(c=>c.id===cu.cid);

return(
<div>
<div className="page-header">
<h1>Ayarlar</h1>
<p>Sistem ayarlarƒ±</p>
</div>

<div className="card">
<div className="card-title"><Icon.Building/>Firma Bilgileri</div>
{isMaster?(
<p style={{color:'var(--muted)'}}>Master hesap olarak t√ºm firmalarƒ± "Firmalar" men√ºs√ºnden y√∂netebilirsiniz.</p>
):(
<div style={{marginTop:16}}>
<p><b>Firma:</b> {myCompany?.name}</p>
<p><b>Kod:</b> {myCompany?.code||'-'}</p>
<p><b>Konum:</b> {myCompany?.lat&&myCompany?.lng?`${myCompany.lat}, ${myCompany.lng}`:'Tanƒ±mlƒ± deƒüil'}</p>
<p><b>Yarƒ±√ßap:</b> {myCompany?.radius||100}m</p>
<p><b>Konum Doƒürulama:</b> {myCompany?.locationCheck?'A√ßƒ±k':'Kapalƒ±'}</p>
</div>
)}
</div>

<div className="card">
<div className="card-title"><Icon.Info/>Sistem Bilgileri</div>
<div style={{marginTop:16}}>
<p><b>Versiyon:</b> 2.0</p>
<p><b>Son G√ºncelleme:</b> Ocak 2025</p>
</div>
</div>
</div>
);
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>

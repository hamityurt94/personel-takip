<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Personel Takip Pro</title>
<meta name="theme-color" content="#6366f1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUGVyc29uZWwgVGFraXAgUHJvIiwic2hvcnRfbmFtZSI6IlBUUyBQcm8iLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBhMGEwZiIsInRoZW1lX2NvbG9yIjoiIzYzNjZmMSJ9">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f0f14;--bg2:#16161e;--card:#1c1c27;--card2:#22222e;--border:#2d2d3a;--text:#f4f4f5;--muted:#8b8b9e;--accent:#818cf8;--accent2:#6366f1;--success:#34d399;--warning:#fbbf24;--danger:#f87171;--info:#38bdf8;--gradient:linear-gradient(135deg,#818cf8 0%,#6366f1 100%)}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--muted)}

/* Login */
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:radial-gradient(ellipse at top,#1a1a2e 0%,var(--bg) 70%)}
.login-box{background:var(--card);border:1px solid var(--border);border-radius:24px;padding:40px;width:100%;max-width:400px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.5)}
.logo{text-align:center;margin-bottom:32px}
.logo-icon{width:64px;height:64px;background:var(--gradient);border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:28px}
.logo h1{font-size:24px;font-weight:700;background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo p{color:var(--muted);font-size:13px;margin-top:4px}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:12px;font-weight:500;color:var(--muted);margin-bottom:6px}
.form-label.req::after{content:' *';color:var(--danger)}
input,select,textarea{width:100%;padding:12px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;transition:all .2s}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(129,140,248,.15)}
input::placeholder,textarea::placeholder{color:var(--muted)}
select{cursor:pointer}
select option{background:var(--bg2);color:var(--text)}
textarea{min-height:100px;resize:vertical}
.btn{padding:12px 20px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:all .2s}
.btn-primary{background:var(--gradient);color:#fff;width:100%}
.btn-primary:hover{opacity:.9;transform:translateY(-1px)}
.btn-success{background:var(--success);color:#000}
.btn-warning{background:var(--warning);color:#000}
.btn-danger{background:var(--danger);color:#fff}
.btn-ghost{background:var(--card2);color:var(--text)}
.btn-sm{padding:8px 14px;font-size:12px}
.btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.err{color:var(--danger);font-size:12px;margin-bottom:12px;padding:10px;background:rgba(248,113,113,.1);border-radius:8px}

/* Layout */
.layout{display:flex;min-height:100vh}
.sidebar{width:260px;background:var(--bg2);border-right:1px solid var(--border);position:fixed;height:100vh;display:flex;flex-direction:column;z-index:100}
.side-header{padding:20px;border-bottom:1px solid var(--border)}
.side-brand{display:flex;align-items:center;gap:12px}
.side-brand-icon{width:40px;height:40px;background:var(--gradient);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
.side-brand h2{font-size:16px;font-weight:700}
.side-brand span{font-size:10px;color:var(--muted);display:block}
.firm-badge{background:var(--accent);color:#fff;padding:4px 10px;border-radius:6px;font-size:10px;font-weight:600;margin-top:8px;display:inline-block}
.firm-badge.master{background:var(--warning);color:#000}
.side-nav{flex:1;overflow-y:auto;padding:12px}
.nav-section{margin-bottom:8px}
.nav-title{font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;padding:12px 12px 8px}
.nav-item{display:flex;align-items:center;gap:10px;padding:11px 14px;border-radius:10px;color:var(--muted);cursor:pointer;font-size:13px;font-weight:500;margin-bottom:2px;transition:all .15s}
.nav-item:hover{background:var(--card);color:var(--text)}
.nav-item.active{background:rgba(129,140,248,.15);color:var(--accent)}
.nav-item svg{width:18px;height:18px;flex-shrink:0}
.nav-item .badge-count{margin-left:auto;background:var(--danger);color:#fff;font-size:10px;padding:2px 6px;border-radius:10px}
.side-footer{padding:16px;border-top:1px solid var(--border)}
.user-card{display:flex;align-items:center;gap:10px;padding:10px;background:var(--card);border-radius:12px;margin-bottom:10px}
.user-avatar{width:38px;height:38px;background:var(--gradient);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px}
.user-avatar.master{background:linear-gradient(135deg,#fbbf24,#f59e0b)}
.user-info h4{font-size:13px;font-weight:600}
.user-info p{font-size:11px;color:var(--muted)}
.logout-btn{width:100%;padding:10px;background:transparent;border:1px solid var(--border);border-radius:10px;color:var(--muted);font-size:12px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .15s}
.logout-btn:hover{background:var(--danger);border-color:var(--danger);color:#fff}

/* Main */
.main{flex:1;margin-left:260px;padding:24px;min-height:100vh}
.page-header{margin-bottom:24px}
.page-header h1{font-size:26px;font-weight:700}
.page-header p{color:var(--muted);font-size:14px;margin-top:4px}
.page-actions{display:flex;gap:10px;margin-top:16px}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.card-title{font-size:15px;font-weight:600;display:flex;align-items:center;gap:8px}
.card-title svg{width:18px;height:18px;color:var(--accent)}

/* Stats */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.stat-card.accent::before{background:var(--accent)}
.stat-card.success::before{background:var(--success)}
.stat-card.warning::before{background:var(--warning)}
.stat-card.danger::before{background:var(--danger)}
.stat-card.info::before{background:var(--info)}
.stat-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:12px}
.stat-icon.accent{background:rgba(129,140,248,.15);color:var(--accent)}
.stat-icon.success{background:rgba(52,211,153,.15);color:var(--success)}
.stat-icon.warning{background:rgba(251,191,36,.15);color:var(--warning)}
.stat-icon.danger{background:rgba(248,113,113,.15);color:var(--danger)}
.stat-icon.info{background:rgba(56,189,248,.15);color:var(--info)}
.stat-icon svg{width:22px;height:22px}
.stat-label{font-size:12px;color:var(--muted);font-weight:500;text-transform:uppercase;letter-spacing:.3px}
.stat-value{font-size:32px;font-weight:800;margin-top:4px}
.stat-change{font-size:11px;margin-top:6px;display:flex;align-items:center;gap:4px}
.stat-change.up{color:var(--success)}
.stat-change.down{color:var(--danger)}

/* Chart */
.chart-container{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px}
.chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.chart-title{font-size:15px;font-weight:600}
.chart-tabs{display:flex;gap:4px;background:var(--bg2);padding:4px;border-radius:8px}
.chart-tab{padding:6px 12px;font-size:11px;font-weight:500;color:var(--muted);cursor:pointer;border-radius:6px;transition:all .15s}
.chart-tab.active{background:var(--accent);color:#fff}
.chart-area{height:200px;display:flex;align-items:end;gap:8px;padding:10px 0}
.chart-bar{flex:1;background:var(--accent);border-radius:6px 6px 0 0;min-height:4px;transition:height .3s;position:relative}
.chart-bar:hover{background:var(--accent2)}
.chart-bar-label{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);font-size:9px;color:var(--muted);white-space:nowrap}
.chart-bar-value{position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:10px;font-weight:600;opacity:0;transition:opacity .15s}
.chart-bar:hover .chart-bar-value{opacity:1}

/* Table */
table{width:100%;border-collapse:collapse}
th,td{padding:12px 14px;text-align:left;border-bottom:1px solid var(--border);font-size:13px}
th{color:var(--muted);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.3px;background:var(--bg2)}
tr:hover td{background:var(--card2)}
.badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-in{background:rgba(52,211,153,.15);color:var(--success)}
.badge-out{background:rgba(129,140,248,.15);color:var(--accent)}
.badge-break{background:rgba(251,191,36,.15);color:var(--warning)}
.badge-pending{background:rgba(251,191,36,.15);color:var(--warning)}
.badge-approved{background:rgba(52,211,153,.15);color:var(--success)}
.badge-rejected{background:rgba(248,113,113,.15);color:var(--danger)}
.badge-active{background:rgba(52,211,153,.15);color:var(--success)}
.badge-passive{background:rgba(248,113,113,.15);color:var(--danger)}
.user-id{font-family:monospace;font-size:11px;color:var(--accent);background:rgba(129,140,248,.1);padding:3px 8px;border-radius:6px}

/* QR Scan */
.qr-section{text-align:center;padding:30px}
.qr-display{width:280px;height:280px;margin:0 auto;background:var(--bg2);border:2px dashed var(--border);border-radius:20px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px}
.qr-display.scanning{border-color:var(--accent);border-style:solid}
#qr-reader{width:100%;max-width:320px;margin:0 auto;border-radius:16px;overflow:hidden}
#qr-reader video{width:100%;border-radius:16px}
.scan-status{padding:14px 20px;border-radius:12px;margin-top:20px;font-size:14px;font-weight:500}
.scan-status.ok{background:rgba(52,211,153,.15);color:var(--success)}
.scan-status.err{background:rgba(248,113,113,.15);color:var(--danger)}
.qr-preview{background:#fff;padding:24px;border-radius:16px;display:inline-block;margin:20px 0}
.qr-preview h3{color:#333;font-size:16px;margin-bottom:16px}
.qr-preview img{display:block}
.qr-preview p{color:#666;font-size:12px;margin-top:16px;font-family:monospace}

/* Action Buttons */
.action-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:20px}
.action-btn{padding:20px;background:var(--card2);border:1px solid var(--border);border-radius:16px;text-align:center;cursor:pointer;transition:all .2s}
.action-btn:hover{border-color:var(--accent);transform:translateY(-2px)}
.action-btn.active{border-color:var(--success);background:rgba(52,211,153,.1)}
.action-btn-icon{width:48px;height:48px;margin:0 auto 12px;border-radius:12px;display:flex;align-items:center;justify-content:center}
.action-btn-icon svg{width:24px;height:24px}
.action-btn-icon.green{background:rgba(52,211,153,.15);color:var(--success)}
.action-btn-icon.red{background:rgba(248,113,113,.15);color:var(--danger)}
.action-btn-icon.yellow{background:rgba(251,191,36,.15);color:var(--warning)}
.action-btn-icon.blue{background:rgba(56,189,248,.15);color:var(--info)}
.action-btn h4{font-size:14px;font-weight:600;margin-bottom:4px}
.action-btn p{font-size:11px;color:var(--muted)}

/* Balance Cards */
.balance-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.balance-card{background:var(--card2);border-radius:12px;padding:16px;text-align:center}
.balance-card h4{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.3px}
.balance-card .val{font-size:36px;font-weight:800;margin-top:6px}
.balance-card.total .val{color:var(--info)}
.balance-card.used .val{color:var(--warning)}
.balance-card.left .val{color:var(--success)}

/* Leave Types */
.leave-type-grid{display:flex;gap:10px;margin-bottom:20px}
.leave-type{flex:1;padding:16px;background:var(--card2);border:2px solid var(--border);border-radius:12px;text-align:center;cursor:pointer;transition:all .15s}
.leave-type:hover{border-color:var(--muted)}
.leave-type.selected{border-color:var(--accent);background:rgba(129,140,248,.1)}
.leave-type-icon{font-size:24px;margin-bottom:8px}
.leave-type h4{font-size:13px;font-weight:600}

/* Form Grid */
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}

/* Filters */
.filters-bar{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;align-items:flex-end}
.filter-group{display:flex;flex-direction:column;gap:6px;min-width:140px}
.filter-group label{font-size:11px;font-weight:500;color:var(--muted)}
.filter-group input,.filter-group select{padding:10px 12px}

/* Settings */
.setting-item{display:flex;align-items:center;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border)}
.setting-item:last-child{border-bottom:none}
.setting-info h4{font-size:14px;font-weight:600}
.setting-info p{font-size:12px;color:var(--muted);margin-top:2px}
.toggle{position:relative;width:48px;height:26px;display:inline-block}
.toggle input{opacity:0;width:0;height:0;position:absolute}
.toggle span{position:absolute;cursor:pointer;inset:0;background:var(--border);border-radius:26px;transition:.3s}
.toggle span::before{content:'';position:absolute;width:20px;height:20px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s}
.toggle input:checked+span{background:var(--success)}
.toggle input:checked+span::before{transform:translateX(22px)}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1001;padding:20px;backdrop-filter:blur(4px)}
.modal{background:var(--card);border:1px solid var(--border);border-radius:20px;width:100%;max-width:500px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
.modal-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-header h2{font-size:18px;font-weight:700}
.modal-close{width:32px;height:32px;border-radius:8px;background:var(--bg2);border:none;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-close:hover{background:var(--danger);color:#fff}
.modal-body{padding:20px;overflow-y:auto;flex:1}
.modal-footer{padding:16px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px}

/* Today Activity */
.today-activity{display:flex;gap:8px;flex-wrap:wrap;margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
.activity-tag{display:flex;align-items:center;gap:6px;padding:8px 12px;background:var(--bg2);border-radius:8px;font-size:12px}
.activity-tag.in{color:var(--success)}
.activity-tag.out{color:var(--accent)}
.activity-tag.break{color:var(--warning)}

/* Birthday Banner */
.birthday-banner{background:linear-gradient(135deg,#818cf8,#6366f1,#4f46e5);border-radius:16px;padding:24px;margin-bottom:20px;text-align:center;position:relative;overflow:hidden}
.birthday-banner::before{content:'ðŸŽ‰';position:absolute;top:10px;left:20px;font-size:30px;opacity:.3}
.birthday-banner::after{content:'ðŸŽ‚';position:absolute;bottom:10px;right:20px;font-size:30px;opacity:.3}
.birthday-banner .emoji{font-size:48px;margin-bottom:12px}
.birthday-banner h2{font-size:22px;font-weight:700}
.birthday-banner p{font-size:14px;opacity:.9;margin-top:6px}

/* Birthday Card */
.birthday-card{display:flex;align-items:center;gap:14px;padding:14px;background:var(--card2);border-radius:12px;margin-bottom:10px}
.birthday-card .avatar{width:44px;height:44px;background:var(--gradient);border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700}
.birthday-card .info h4{font-size:14px;font-weight:600}
.birthday-card .info p{font-size:12px;color:var(--muted)}

/* Notification Toast */
.toast-container{position:fixed;top:20px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:10px}
.toast{padding:14px 20px;background:var(--card);border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;gap:12px;box-shadow:0 10px 30px rgba(0,0,0,.3);animation:slideIn .3s ease}
.toast.success{border-left:4px solid var(--success)}
.toast.error{border-left:4px solid var(--danger)}
.toast.warning{border-left:4px solid var(--warning)}
.toast.info{border-left:4px solid var(--info)}
.toast-icon{width:24px;height:24px}
.toast-content h4{font-size:13px;font-weight:600}
.toast-content p{font-size:12px;color:var(--muted)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* Mobile Menu */
.mobile-menu-btn{display:none;position:fixed;bottom:24px;right:24px;width:56px;height:56px;background:var(--gradient);border-radius:16px;align-items:center;justify-content:center;cursor:pointer;z-index:99;box-shadow:0 10px 30px rgba(99,102,241,.4)}
.mobile-menu-btn svg{width:24px;height:24px;color:#fff}
.mobile-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:99;backdrop-filter:blur(2px)}

/* PWA Install */
.pwa-banner{background:var(--gradient);border-radius:12px;padding:16px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between}
.pwa-banner-text{display:flex;align-items:center;gap:12px}
.pwa-banner-text svg{width:24px;height:24px}
.pwa-banner-text h4{font-size:14px;font-weight:600}
.pwa-banner-text p{font-size:12px;opacity:.8}
.pwa-install-btn{padding:8px 16px;background:#fff;color:var(--accent2);border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer}

/* Vardiya */
.shift-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.shift-card{background:var(--card2);border:2px solid var(--border);border-radius:12px;padding:16px;text-align:center;cursor:pointer;transition:all .15s}
.shift-card:hover{border-color:var(--muted)}
.shift-card.selected{border-color:var(--accent);background:rgba(129,140,248,.1)}
.shift-card-icon{font-size:28px;margin-bottom:8px}
.shift-card h4{font-size:13px;font-weight:600}
.shift-card p{font-size:11px;color:var(--muted)}

/* Overtime */
.overtime-display{background:linear-gradient(135deg,rgba(251,191,36,.1),rgba(251,191,36,.05));border:1px solid rgba(251,191,36,.3);border-radius:12px;padding:16px;margin-top:16px}
.overtime-display h4{font-size:12px;color:var(--warning);text-transform:uppercase}
.overtime-display .val{font-size:28px;font-weight:800;color:var(--warning)}

/* Loading */
.loading-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:20px}
.spinner{width:48px;height:48px;border:4px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-screen p{color:var(--muted);font-size:14px}

/* Responsive */
@media(max-width:900px){
.sidebar{transform:translateX(-100%);transition:transform .3s}
.sidebar.open{transform:translateX(0)}
.main{margin-left:0}
.mobile-menu-btn{display:flex}
.mobile-overlay.show{display:block}
.stats-grid{grid-template-columns:repeat(2,1fr)}
.balance-grid{grid-template-columns:1fr}
.form-row{grid-template-columns:1fr}
.shift-grid{grid-template-columns:1fr}
.leave-type-grid{flex-direction:column}
.action-grid{grid-template-columns:1fr}
.filters-bar{flex-direction:column;align-items:stretch}
.filter-group{width:100%}
.chart-area{height:150px}
}
</style>
</head>
<body>
<div id="root"><div class="loading-screen"><div class="spinner"></div><p>YÃ¼kleniyor...</p></div></div>

<script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js"></script>

<script type="text/babel">
const {useState,useEffect,useRef}=React;

// Config
const SUPABASE_URL='https://qzbncrbjilwuzjpaprfb.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6Ym5jcmJqaWx3dXpqcGFwcmZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NjcxMzUsImV4cCI6MjA4NDA0MzEzNX0.FRxePkN76FAp9Tl36TvsAEGI7qvjqj6wj0gCO8x0cjI';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

// Helpers
const TODAY=new Date();
const TODAY_STR=String(TODAY.getDate()).padStart(2,'0')+'.'+String(TODAY.getMonth()+1).padStart(2,'0');
const TODAY_FULL=TODAY.toLocaleDateString('tr-TR');
const NOW_TIME=()=>new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
const LTYPES=[
{id:'yillik',name:'YÄ±llÄ±k Ä°zin',icon:'ðŸ–ï¸',clr:'#34d399'},
{id:'mazeret',name:'Mazeret Ä°zni',icon:'ðŸ“‹',clr:'#38bdf8'},
{id:'hastalik',name:'HastalÄ±k',icon:'ðŸ¥',clr:'#f87171'},
{id:'ucretsiz',name:'Ãœcretsiz',icon:'ðŸ“',clr:'#fbbf24'}
];
const SHIFTS=[
{id:'sabah',name:'Sabah',icon:'ðŸŒ…',start:'08:00',end:'17:00'},
{id:'aksam',name:'AkÅŸam',icon:'ðŸŒ†',start:'16:00',end:'00:00'},
{id:'gece',name:'Gece',icon:'ðŸŒ™',start:'00:00',end:'08:00'}
];
const isBday=bd=>{if(!bd)return false;const p=bd.split('.');return p.length>=2&&TODAY_STR===p[0]+'.'+p[1];};
const calcMinutes=(t1,t2)=>{const[h1,m1]=t1.split(':').map(Number);const[h2,m2]=t2.split(':').map(Number);return(h2*60+m2)-(h1*60+m1);};
const formatMin=m=>{const h=Math.floor(m/60);const min=m%60;return h>0?`${h}s ${min}dk`:`${min}dk`;};
const toExcel=(d,f)=>{const ws=XLSX.utils.json_to_sheet(d);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Rapor');XLSX.writeFile(wb,f+'.xlsx');};

// Icons
const Icon={
Dash:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg>,
Scan:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>,
Clock:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>,
Calendar:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>,
Users:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>,
Building:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M9 22v-4h6v4M8 6h.01M16 6h.01M12 6h.01M8 10h.01M16 10h.01M12 10h.01M8 14h.01M16 14h.01M12 14h.01"/></svg>,
Settings:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>,
Logout:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>,
Menu:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
X:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
Plus:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
Edit:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
Download:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>,
QR:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>,
Print:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
Check:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20,6 9,17 4,12"/></svg>,
Coffee:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8h1a4 4 0 010 8h-1M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>,
Play:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5,3 19,12 5,21"/></svg>,
Pause:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>,
TrendUp:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23,6 13.5,15.5 8.5,10.5 1,18"/><polyline points="17,6 23,6 23,12"/></svg>,
Bell:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>,
File:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/></svg>,
Briefcase:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>,
Award:()=><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="8" r="7"/><polyline points="8.21,13.89 7,23 12,20 17,23 15.79,13.88"/></svg>
};

// Toast System
const ToastContext=React.createContext();
function ToastProvider({children}){
const[toasts,setToasts]=useState([]);
const addToast=(type,title,message)=>{
const id=Date.now();
setToasts(p=>[...p,{id,type,title,message}]);
setTimeout(()=>setToasts(p=>p.filter(t=>t.id!==id)),4000);
};
return(
<ToastContext.Provider value={{addToast}}>
{children}
<div className="toast-container">
{toasts.map(t=>(
<div key={t.id} className={`toast ${t.type}`}>
<div className="toast-content"><h4>{t.title}</h4><p>{t.message}</p></div>
</div>
))}
</div>
</ToastContext.Provider>
);
}
const useToast=()=>React.useContext(ToastContext);

// Main App
function App(){
const[user,setUser]=useState(null);
const[loading,setLoading]=useState(true);
const[page,setPage]=useState('dash');
const[sideOpen,setSideOpen]=useState(false);
const[viewCo,setViewCo]=useState('all');
const[users,setUsers]=useState([]);
const[companies,setCompanies]=useState([]);
const[roles,setRoles]=useState({});
const[att,setAtt]=useState([]);
const[leaves,setLeaves]=useState([]);
const[breaks,setBreaks]=useState([]);
const[shifts,setShifts]=useState([]);
const[notifCount,setNotifCount]=useState(0);

useEffect(()=>{
const saved=localStorage.getItem('pts_user');
if(saved)setUser(JSON.parse(saved));
loadData();
},[]);

useEffect(()=>{
if(user){
const pending=leaves.filter(l=>l.status==='pending'&&l.approver===user.id).length;
setNotifCount(pending);
}
},[leaves,user]);

const loadData=async()=>{
try{
const[c,r,u,a,l,b,s]=await Promise.all([
supabase.from('companies').select('*'),
supabase.from('roles').select('*'),
supabase.from('users').select('*'),
supabase.from('attendance').select('*').order('created_at',{ascending:false}).limit(1000),
supabase.from('leaves').select('*'),
supabase.from('breaks').select('*').order('created_at',{ascending:false}).limit(500),
supabase.from('user_shifts').select('*')
]);
if(c.data)setCompanies(c.data.map(x=>({id:x.id,name:x.name,qr:x.qr,locReq:x.loc_req,lat:+x.lat,lng:+x.lng,radius:x.radius,dailyMin:x.daily_min,active:x.active})));
if(r.data){const o={};r.data.forEach(x=>o[x.id]=x.name);setRoles(o);}
if(u.data)setUsers(u.data.map(x=>({id:x.id,oderId:x.order_id,name:x.name,email:x.email,pw:x.password,role:x.role,cid:x.company_id,mid:x.manager_id,annual:x.annual_leave,used:x.used_leave,viewOT:x.view_ot,birthDate:x.birth_date,startDate:x.start_date,shift:x.shift||'sabah',active:x.active})));
if(a.data)setAtt(a.data.map(x=>({id:x.id,uid:x.user_id,cid:x.company_id,type:x.type,time:x.time,date:x.date})));
if(l.data)setLeaves(l.data.map(x=>({id:x.id,uid:x.user_id,type:x.type,start:x.start_date,end:x.end_date,reason:x.reason,status:x.status,approver:x.approver_id,chain:x.chain||[]})));
if(b.data)setBreaks(b.data.map(x=>({id:x.id,uid:x.user_id,start:x.start_time,end:x.end_time,date:x.date,duration:x.duration})));
}catch(e){console.error(e);}
setLoading(false);
};

if(loading)return<div className="loading-screen"><div className="spinner"></div><p>YÃ¼kleniyor...</p></div>;
if(!user)return<Login users={users} companies={companies} onLogin={u=>{setUser(u);localStorage.setItem('pts_user',JSON.stringify(u));}}/>;

const cu=users.find(x=>x.id===user.id)||user;
if(cu.cid){const uc=companies.find(x=>x.id===cu.cid);if(uc&&!uc.active)return<Blocked msg="FirmanÄ±z pasif durumda" logout={()=>{setUser(null);localStorage.removeItem('pts_user');}}/>;}
if(!cu.active)return<Blocked msg="HesabÄ±nÄ±z pasif durumda" logout={()=>{setUser(null);localStorage.removeItem('pts_user');}}/>;

const isMaster=cu.role==='master',isAdmin=cu.role==='firma_admin',isGM=cu.role==='gm',isAmir=cu.role==='amir';
const canManage=isMaster||isAdmin||isGM||isAmir;
const cid=isMaster?(viewCo==='all'?null:viewCo):cu.cid;
const fUsers=cid?users.filter(x=>x.cid===cid):users;
const fAtt=cid?att.filter(x=>x.cid===cid):att;
const fLeaves=cid?leaves.filter(x=>{const u=users.find(y=>y.id===x.uid);return u&&u.cid===cid;}):leaves;
const fBreaks=cid?breaks.filter(x=>{const u=users.find(y=>y.id===x.uid);return u&&u.cid===cid;}):breaks;
const bdayUsers=fUsers.filter(x=>x.active&&isBday(x.birthDate));
const myBday=isBday(cu.birthDate);
const comp=companies.find(x=>x.id===cu.cid);

const nav=p=>{setPage(p);setSideOpen(false);};
const logout=()=>{setUser(null);localStorage.removeItem('pts_user');setPage('dash');};

return(
<ToastProvider>
<div className="layout">
<div className={`mobile-overlay ${sideOpen?'show':''}`} onClick={()=>setSideOpen(false)}/>
<aside className={`sidebar ${sideOpen?'open':''}`}>
<div className="side-header">
<div className="side-brand">
<div className="side-brand-icon">ðŸ“Š</div>
<div><h2>PTS Pro</h2><span>v6.0</span></div>
</div>
{isMaster&&<div className="firm-badge master">Master Admin</div>}
{isAdmin&&comp&&<div className="firm-badge">{comp.name}</div>}
</div>
{isMaster&&<div style={{padding:'12px 16px'}}><select value={viewCo} onChange={e=>setViewCo(e.target.value)} style={{width:'100%'}}><option value="all">TÃ¼m Firmalar</option>{companies.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>}
<nav className="side-nav">
<div className="nav-section">
<div className="nav-title">Ana MenÃ¼</div>
<div className={`nav-item ${page==='dash'?'active':''}`} onClick={()=>nav('dash')}><Icon.Dash/><span>Dashboard</span></div>
{!isMaster&&!isAdmin&&<div className={`nav-item ${page==='qr'?'active':''}`} onClick={()=>nav('qr')}><Icon.Scan/><span>GiriÅŸ/Ã‡Ä±kÄ±ÅŸ</span></div>}
<div className={`nav-item ${page==='att'?'active':''}`} onClick={()=>nav('att')}><Icon.Clock/><span>Puantaj</span></div>
</div>
<div className="nav-section">
<div className="nav-title">Ä°zin YÃ¶netimi</div>
{!isMaster&&!isAdmin&&<>
<div className={`nav-item ${page==='bal'?'active':''}`} onClick={()=>nav('bal')}><Icon.Calendar/><span>Ä°zin Bakiyem</span></div>
<div className={`nav-item ${page==='req'?'active':''}`} onClick={()=>nav('req')}><Icon.Plus/><span>Ä°zin Talebi</span></div>
</>}
<div className={`nav-item ${page==='llist'?'active':''}`} onClick={()=>nav('llist')}><Icon.File/><span>{canManage?'Ä°zin OnaylarÄ±':'Ä°zinlerim'}</span>{notifCount>0&&canManage&&<span className="badge-count">{notifCount}</span>}</div>
</div>
{canManage&&<div className="nav-section">
<div className="nav-title">YÃ¶netim</div>
<div className={`nav-item ${page==='users'?'active':''}`} onClick={()=>nav('users')}><Icon.Users/><span>Personeller</span></div>
{isMaster&&<div className={`nav-item ${page==='comp'?'active':''}`} onClick={()=>nav('comp')}><Icon.Building/><span>Firmalar</span></div>}
{isMaster&&<div className={`nav-item ${page==='roles'?'active':''}`} onClick={()=>nav('roles')}><Icon.Award/><span>Roller</span></div>}
{(isAdmin||isGM)&&<div className={`nav-item ${page==='mycomp'?'active':''}`} onClick={()=>nav('mycomp')}><Icon.QR/><span>Firma QR</span></div>}
{(isMaster||isAdmin)&&<div className={`nav-item ${page==='set'?'active':''}`} onClick={()=>nav('set')}><Icon.Settings/><span>Ayarlar</span></div>}
</div>}
</nav>
<div className="side-footer">
<div className="user-card">
<div className={`user-avatar ${isMaster?'master':''}`}>{cu.name.charAt(0)}</div>
<div className="user-info"><h4>{cu.name}</h4><p>{roles[cu.role]||cu.role}</p></div>
</div>
<button className="logout-btn" onClick={logout}><Icon.Logout/><span>Ã‡Ä±kÄ±ÅŸ Yap</span></button>
</div>
</aside>
<main className="main">
{page==='dash'&&<Dashboard cu={cu} att={fAtt} leaves={fLeaves} breaks={fBreaks} users={fUsers} companies={companies} roles={roles} isMaster={isMaster} isAdmin={isAdmin} viewCo={viewCo} bdayUsers={bdayUsers} myBday={myBday} comp={comp}/>}
{page==='qr'&&<QRScan cu={cu} att={att} setAtt={setAtt} breaks={breaks} setBreaks={setBreaks} comp={comp}/>}
{page==='att'&&<Attendance cu={cu} att={fAtt} breaks={fBreaks} users={fUsers} canManage={canManage}/>}
{page==='bal'&&<Balance cu={cu}/>}
{page==='req'&&<LeaveReq cu={cu} users={users} setLeaves={setLeaves}/>}
{page==='llist'&&<LeaveList cu={cu} leaves={fLeaves} users={users} setLeaves={setLeaves} canManage={canManage}/>}
{page==='users'&&<Users users={fUsers} setUsers={setUsers} companies={companies} roles={roles} isMaster={isMaster} isAdmin={isAdmin} cu={cu}/>}
{page==='comp'&&<Companies companies={companies} setCompanies={setCompanies} users={users}/>}
{page==='roles'&&<Roles roles={roles} setRoles={setRoles}/>}
{page==='mycomp'&&<MyCompany comp={comp} setCompanies={setCompanies}/>}
{page==='set'&&<Settings companies={isMaster?companies:[comp].filter(Boolean)} setCompanies={setCompanies}/>}
</main>
<div className="mobile-menu-btn" onClick={()=>setSideOpen(!sideOpen)}><Icon.Menu/></div>
</div>
</ToastProvider>
);
}

function Blocked({msg,logout}){
return(
<div className="login-wrap">
<div className="login-box" style={{textAlign:'center'}}>
<div className="logo-icon" style={{background:'linear-gradient(135deg,#f87171,#ef4444)'}}>ðŸš«</div>
<h2 style={{marginTop:20,marginBottom:10}}>EriÅŸim Engellendi</h2>
<p style={{color:'var(--danger)',marginBottom:24}}>{msg}</p>
<button className="btn btn-primary" onClick={logout}>Ã‡Ä±kÄ±ÅŸ Yap</button>
</div>
</div>
);
}

function Login({users,companies,onLogin}){
const[email,setEmail]=useState('');
const[pw,setPw]=useState('');
const[err,setErr]=useState('');
const[loading,setLoading]=useState(false);
const submit=e=>{
e.preventDefault();
setLoading(true);
setTimeout(()=>{
const u=users.find(x=>x.email===email&&x.pw===pw);
if(!u){setErr('GeÃ§ersiz e-posta veya ÅŸifre');setLoading(false);return;}
if(!u.active){setErr('HesabÄ±nÄ±z pasif durumda');setLoading(false);return;}
if(u.cid){const c=companies.find(x=>x.id===u.cid);if(c&&!c.active){setErr('FirmanÄ±z pasif durumda');setLoading(false);return;}}
onLogin(u);
},500);
};
return(
<div className="login-wrap">
<div className="login-box">
<div className="logo">
<div className="logo-icon">ðŸ“Š</div>
<h1>Personel Takip Pro</h1>
<p>GiriÅŸ yaparak devam edin</p>
</div>
<form onSubmit={submit}>
<div className="form-group">
<label className="form-label">E-posta Adresi</label>
<input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="ornek@firma.com"/>
</div>
<div className="form-group">
<label className="form-label">Åžifre</label>
<input type="password" value={pw} onChange={e=>setPw(e.target.value)} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
</div>
{err&&<div className="err">{err}</div>}
<button className="btn btn-primary" disabled={loading}>{loading?'GiriÅŸ yapÄ±lÄ±yor...':'GiriÅŸ Yap'}</button>
</form>
</div>
</div>
);
}

function Dashboard({cu,att,leaves,breaks,users,companies,roles,isMaster,isAdmin,viewCo,bdayUsers,myBday,comp}){
const canSee=isMaster||isAdmin||['gm','amir'].includes(cu.role);
const todayAtt=att.filter(x=>x.date===TODAY_FULL);
const todayIn=todayAtt.filter(x=>x.type==='in').length;
const todayOut=todayAtt.filter(x=>x.type==='out').length;
const pending=leaves.filter(x=>x.status==='pending').length;
const staff=users.filter(x=>x.active&&!['master','firma_admin'].includes(x.role)).length;
const myTodayAtt=att.filter(x=>x.uid===cu.id&&x.date===TODAY_FULL);
const myTodayBreaks=breaks.filter(x=>x.uid===cu.id&&x.date===TODAY_FULL);

// Hesaplamalar
const calcOvertime=()=>{
if(!comp||!myTodayAtt.length)return 0;
const ins=myTodayAtt.filter(x=>x.type==='in').sort((a,b)=>a.time.localeCompare(b.time));
const outs=myTodayAtt.filter(x=>x.type==='out').sort((a,b)=>a.time.localeCompare(b.time));
let totalMin=0;
ins.forEach((inRec,i)=>{
const outRec=outs[i];
if(outRec)totalMin+=calcMinutes(inRec.time,outRec.time);
});
const breakMin=myTodayBreaks.reduce((s,b)=>s+(b.duration||0),0);
totalMin-=breakMin;
const overtime=totalMin-(comp.dailyMin||540);
return overtime>0?overtime:0;
};

// HaftalÄ±k grafik verisi
const getWeekData=()=>{
const days=['Pzt','Sal','Ã‡ar','Per','Cum','Cmt','Paz'];
const data=[];
for(let i=6;i>=0;i--){
const d=new Date();
d.setDate(d.getDate()-i);
const ds=d.toLocaleDateString('tr-TR');
const count=att.filter(x=>x.date===ds&&x.type==='in').length;
data.push({day:days[d.getDay()===0?6:d.getDay()-1],count,date:ds});
}
return data;
};
const weekData=getWeekData();
const maxCount=Math.max(...weekData.map(d=>d.count),1);

return(
<div>
{myBday&&comp&&<div className="birthday-banner"><div className="emoji">ðŸŽ‚</div><h2>DoÄŸum GÃ¼nÃ¼n Kutlu Olsun!</h2><p>{comp.name} ailesi olarak nice mutlu yÄ±llar dileriz!</p></div>}

<div className="page-header">
<h1>HoÅŸ Geldin, {cu.name}! ðŸ‘‹</h1>
<p>{TODAY_FULL} - {['Pazar','Pazartesi','SalÄ±','Ã‡arÅŸamba','PerÅŸembe','Cuma','Cumartesi'][TODAY.getDay()]}</p>
</div>

<div className="stats-grid">
{isMaster&&viewCo==='all'&&<div className="stat-card info"><div className="stat-icon info"><Icon.Building/></div><div className="stat-label">Toplam Firma</div><div className="stat-value">{companies.length}</div></div>}
{canSee&&<>
<div className="stat-card success"><div className="stat-icon success"><Icon.Check/></div><div className="stat-label">BugÃ¼n GiriÅŸ</div><div className="stat-value" style={{color:'var(--success)'}}>{todayIn}</div></div>
<div className="stat-card accent"><div className="stat-icon accent"><Icon.Users/></div><div className="stat-label">Toplam Personel</div><div className="stat-value">{staff}</div></div>
<div className="stat-card warning"><div className="stat-icon warning"><Icon.Bell/></div><div className="stat-label">Bekleyen Ä°zin</div><div className="stat-value" style={{color:'var(--warning)'}}>{pending}</div></div>
</>}
{!canSee&&<>
<div className="stat-card success"><div className="stat-icon success"><Icon.Check/></div><div className="stat-label">BugÃ¼n GiriÅŸ</div><div className="stat-value" style={{color:'var(--success)'}}>{myTodayAtt.filter(x=>x.type==='in').length}</div></div>
<div className="stat-card accent"><div className="stat-icon accent"><Icon.Calendar/></div><div className="stat-label">Kalan Ä°zin</div><div className="stat-value">{cu.annual-cu.used}</div></div>
<div className="stat-card warning"><div className="stat-icon warning"><Icon.Clock/></div><div className="stat-label">Fazla Mesai</div><div className="stat-value" style={{color:'var(--warning)'}}>{formatMin(calcOvertime())}</div></div>
</>}
</div>

{canSee&&<div className="chart-container">
<div className="chart-header">
<div className="chart-title">HaftalÄ±k GiriÅŸ GrafiÄŸi</div>
</div>
<div className="chart-area">
{weekData.map((d,i)=>(
<div key={i} className="chart-bar" style={{height:`${(d.count/maxCount)*100}%`}}>
<span className="chart-bar-value">{d.count}</span>
<span className="chart-bar-label">{d.day}</span>
</div>
))}
</div>
</div>}

{bdayUsers.length>0&&<div className="card">
<div className="card-header"><div className="card-title">ðŸŽ‚ BugÃ¼n DoÄŸum GÃ¼nÃ¼ Olanlar</div></div>
{bdayUsers.map(u=><div className="birthday-card" key={u.id}><div className="avatar">{u.name.charAt(0)}</div><div className="info"><h4>{u.name}</h4><p>{roles[u.role]}</p></div></div>)}
</div>}

<div className="card">
<div className="card-header"><div className="card-title"><Icon.Clock/>{canSee?'Son Hareketler':'BugÃ¼nkÃ¼ Hareketlerim'}</div></div>
<table>
<thead><tr>{canSee&&<th>Personel</th>}<th>Ä°ÅŸlem</th><th>Saat</th><th>Tarih</th></tr></thead>
<tbody>
{(canSee?att:myTodayAtt).slice(0,10).map((r,i)=>{
const u=users.find(x=>x.id===r.uid);
return<tr key={i}>{canSee&&<td>{u?u.name:'-'}</td>}<td><span className={`badge badge-${r.type}`}>{r.type==='in'?'GiriÅŸ':'Ã‡Ä±kÄ±ÅŸ'}</span></td><td>{r.time}</td><td>{r.date}</td></tr>;
})}
</tbody>
</table>
</div>
</div>
);
}

function QRScan({cu,att,setAtt,breaks,setBreaks,comp}){
const toast=useToast();
const[scanning,setScanning]=useState(false);
const[status,setStatus]=useState(null);
const[saving,setSaving]=useState(false);
const[breakActive,setBreakActive]=useState(false);
const[breakStart,setBreakStart]=useState(null);
const scannerRef=useRef(null);
const todayAtt=att.filter(x=>x.uid===cu.id&&x.date===TODAY_FULL);
const todayBreaks=breaks.filter(x=>x.uid===cu.id&&x.date===TODAY_FULL);
const last=todayAtt[0];

useEffect(()=>{
const activeBreak=todayBreaks.find(b=>b.start&&!b.end);
if(activeBreak){setBreakActive(true);setBreakStart(activeBreak.start);}
},[]);

const startScan=async()=>{
setStatus(null);
try{
const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
stream.getTracks().forEach(t=>t.stop());
setScanning(true);
setTimeout(()=>{
if(scannerRef.current)return;
scannerRef.current=new Html5Qrcode('qr-reader');
scannerRef.current.start({facingMode:'environment'},{fps:10,qrbox:{width:250,height:250}},onScanOk,()=>{}).catch(e=>{
setStatus({ok:false,msg:'Kamera baÅŸlatÄ±lamadÄ±'});
setScanning(false);
});
},100);
}catch(e){
if(e.name==='NotAllowedError')setStatus({ok:false,msg:'Kamera izni verilmedi'});
else setStatus({ok:false,msg:'Kamera eriÅŸim hatasÄ±'});
}
};

const stopScan=async()=>{
if(scannerRef.current){
try{await scannerRef.current.stop();scannerRef.current.clear();scannerRef.current=null;}catch(e){}
}
setScanning(false);
};

const onScanOk=async txt=>{
await stopScan();
const scannedQR=txt.trim();
const companyQR=comp?comp.qr.trim():'';
if(!comp){setStatus({ok:false,msg:'Firma bilgisi bulunamadÄ±'});return;}
if(scannedQR!==companyQR){setStatus({ok:false,msg:'GeÃ§ersiz QR kod!'});return;}
if(comp.locReq){
try{
const pos=await new Promise((r,j)=>navigator.geolocation.getCurrentPosition(r,j,{timeout:10000}));
const R=6371e3,lat1=pos.coords.latitude*Math.PI/180,lat2=comp.lat*Math.PI/180,dLat=(comp.lat-pos.coords.latitude)*Math.PI/180,dLon=(comp.lng-pos.coords.longitude)*Math.PI/180;
const a=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2,dist=R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
if(dist>comp.radius){setStatus({ok:false,msg:`Konum dÄ±ÅŸÄ±ndasÄ±nÄ±z (${Math.round(dist)}m)`});return;}
}catch(e){setStatus({ok:false,msg:'Konum alÄ±namadÄ±'});return;}
}
const type=!last||last.type==='out'?'in':'out';
const time=NOW_TIME();
setSaving(true);
const{data,error}=await supabase.from('attendance').insert({user_id:cu.id,company_id:cu.cid,type,time,date:TODAY_FULL}).select().single();
setSaving(false);
if(error){setStatus({ok:false,msg:'KayÄ±t hatasÄ±'});return;}
setAtt(p=>[{id:data.id,uid:cu.id,cid:cu.cid,type,time,date:TODAY_FULL},...p]);
setStatus({ok:true,msg:type==='in'?'GiriÅŸ kaydedildi!':'Ã‡Ä±kÄ±ÅŸ kaydedildi!'});
toast.addToast('success',type==='in'?'GiriÅŸ YapÄ±ldÄ±':'Ã‡Ä±kÄ±ÅŸ YapÄ±ldÄ±',`Saat: ${time}`);
};

const toggleBreak=async()=>{
setSaving(true);
if(!breakActive){
const time=NOW_TIME();
const{data,error}=await supabase.from('breaks').insert({user_id:cu.id,start_time:time,date:TODAY_FULL}).select().single();
if(!error){
setBreaks(p=>[{id:data.id,uid:cu.id,start:time,end:null,date:TODAY_FULL,duration:null},...p]);
setBreakActive(true);
setBreakStart(time);
toast.addToast('warning','Mola BaÅŸladÄ±',`BaÅŸlangÄ±Ã§: ${time}`);
}
}else{
const time=NOW_TIME();
const activeBreak=breaks.find(b=>b.uid===cu.id&&b.date===TODAY_FULL&&b.start&&!b.end);
if(activeBreak){
const duration=calcMinutes(activeBreak.start,time);
await supabase.from('breaks').update({end_time:time,duration}).eq('id',activeBreak.id);
setBreaks(p=>p.map(b=>b.id===activeBreak.id?{...b,end:time,duration}:b));
toast.addToast('success','Mola Bitti',`SÃ¼re: ${formatMin(duration)}`);
}
setBreakActive(false);
setBreakStart(null);
}
setSaving(false);
};

useEffect(()=>()=>{if(scannerRef.current)scannerRef.current.stop().catch(()=>{});},[]);

const totalBreakMin=todayBreaks.reduce((s,b)=>s+(b.duration||0),0);

return(
<div>
<div className="page-header"><h1>GiriÅŸ / Ã‡Ä±kÄ±ÅŸ</h1><p>{comp?comp.name:'Firma seÃ§ilmedi'}</p></div>

<div className="card">
<div className="qr-section">
{!scanning?
<div className="qr-display">
<Icon.Scan style={{width:64,height:64,color:'var(--muted)'}}/>
<p style={{color:'var(--muted)'}}>QR okutmak iÃ§in baÅŸlatÄ±n</p>
</div>:
<div id="qr-reader" style={{maxWidth:320,margin:'0 auto'}}></div>
}
<div style={{marginTop:20}}>
{!scanning?
<button className="btn btn-primary" onClick={startScan} disabled={saving} style={{maxWidth:280,margin:'0 auto'}}>
{(!last||last.type==='out')?'ðŸŸ¢ GiriÅŸ Ä°Ã§in Tara':'ðŸ”´ Ã‡Ä±kÄ±ÅŸ Ä°Ã§in Tara'}
</button>:
<button className="btn btn-danger" onClick={stopScan} style={{maxWidth:280,margin:'0 auto'}}>KamerayÄ± Kapat</button>
}
</div>
{status&&<div className={`scan-status ${status.ok?'ok':'err'}`}>{status.msg}</div>}
</div>

<div className="action-grid">
<div className={`action-btn ${breakActive?'active':''}`} onClick={toggleBreak}>
<div className={`action-btn-icon ${breakActive?'red':'yellow'}`}>{breakActive?<Icon.Pause/>:<Icon.Coffee/>}</div>
<h4>{breakActive?'MolayÄ± Bitir':'Mola BaÅŸlat'}</h4>
<p>{breakActive?`BaÅŸlangÄ±Ã§: ${breakStart}`:`BugÃ¼n: ${formatMin(totalBreakMin)}`}</p>
</div>
<div className="action-btn">
<div className="action-btn-icon blue"><Icon.Clock/></div>
<h4>Ã‡alÄ±ÅŸma SÃ¼resi</h4>
<p>BugÃ¼n aktif</p>
</div>
</div>

{todayAtt.length>0&&<div className="today-activity">
<span style={{fontSize:12,color:'var(--muted)',marginRight:8}}>BugÃ¼n:</span>
{todayAtt.map((r,i)=><div key={i} className={`activity-tag ${r.type}`}>{r.type==='in'?'GiriÅŸ':'Ã‡Ä±kÄ±ÅŸ'} {r.time}</div>)}
{todayBreaks.filter(b=>b.duration).map((b,i)=><div key={`b${i}`} className="activity-tag break">Mola {formatMin(b.duration)}</div>)}
</div>}
</div>
</div>
);
}

function Attendance({cu,att,breaks,users,canManage}){
const[fUser,setFUser]=useState('all');
const[fStart,setFStart]=useState('');
const[fEnd,setFEnd]=useState('');
let data=canManage?att:att.filter(x=>x.uid===cu.id);
if(canManage){
if(fUser!=='all')data=data.filter(x=>x.uid===fUser);
if(fStart)data=data.filter(x=>{const p=x.date.split('.');return new Date(p[2],p[1]-1,p[0])>=new Date(fStart);});
if(fEnd)data=data.filter(x=>{const p=x.date.split('.');return new Date(p[2],p[1]-1,p[0])<=new Date(fEnd);});
}
const staff=users.filter(x=>x.active&&!['master','firma_admin'].includes(x.role));
const exp=()=>{toExcel(data.map(r=>{const u=users.find(x=>x.id===r.uid);return{'Sicil':u?u.oderId:'','Ad':u?u.name:'','Ä°ÅŸlem':r.type==='in'?'GiriÅŸ':'Ã‡Ä±kÄ±ÅŸ','Saat':r.time,'Tarih':r.date};}),'puantaj_raporu');};

return(
<div>
<div className="page-header"><h1>Puantaj</h1><p>GiriÅŸ Ã§Ä±kÄ±ÅŸ kayÄ±tlarÄ±</p></div>
{canManage&&<div className="card">
<div className="filters-bar">
<div className="filter-group"><label>BaÅŸlangÄ±Ã§</label><input type="date" value={fStart} onChange={e=>setFStart(e.target.value)}/></div>
<div className="filter-group"><label>BitiÅŸ</label><input type="date" value={fEnd} onChange={e=>setFEnd(e.target.value)}/></div>
<div className="filter-group"><label>Personel</label><select value={fUser} onChange={e=>setFUser(e.target.value)}><option value="all">TÃ¼mÃ¼</option>{staff.map(u=><option key={u.id} value={u.id}>{u.name}</option>)}</select></div>
<button className="btn btn-ghost btn-sm" onClick={()=>{setFUser('all');setFStart('');setFEnd('');}}>Temizle</button>
<button className="btn btn-success btn-sm" onClick={exp}><Icon.Download/>Excel</button>
</div>
</div>}
<div className="card">
<div className="card-header"><div className="card-title">{data.length} kayÄ±t bulundu</div></div>
<table>
<thead><tr>{canManage&&<th>Sicil</th>}{canManage&&<th>Personel</th>}<th>Ä°ÅŸlem</th><th>Saat</th><th>Tarih</th></tr></thead>
<tbody>{data.slice(0,50).map((r,i)=>{const u=users.find(x=>x.id===r.uid);return<tr key={i}>{canManage&&<td><span className="user-id">{u?u.oderId:''}</span></td>}{canManage&&<td>{u?u.name:''}</td>}<td><span className={`badge badge-${r.type}`}>{r.type==='in'?'GiriÅŸ':'Ã‡Ä±kÄ±ÅŸ'}</span></td><td>{r.time}</td><td>{r.date}</td></tr>;})}</tbody>
</table>
</div>
</div>
);
}

function Balance({cu}){
return(
<div>
<div className="page-header"><h1>Ä°zin Bakiyem</h1><p>YÄ±llÄ±k izin durumunuz</p></div>
<div className="balance-grid">
<div className="balance-card total"><h4>Toplam Hak</h4><div className="val">{cu.annual}</div></div>
<div className="balance-card used"><h4>KullanÄ±lan</h4><div className="val">{cu.used}</div></div>
<div className="balance-card left"><h4>Kalan</h4><div className="val">{cu.annual-cu.used}</div></div>
</div>
<div className="card">
<div className="card-title">Ä°zin TÃ¼rleri</div>
<div className="leave-type-grid">
{LTYPES.map(t=><div key={t.id} className="leave-type"><div className="leave-type-icon">{t.icon}</div><h4 style={{color:t.clr}}>{t.name}</h4></div>)}
</div>
</div>
</div>
);
}

function LeaveReq({cu,users,setLeaves}){
const toast=useToast();
const[type,setType]=useState('');
const[start,setStart]=useState('');
const[end,setEnd]=useState('');
const[reason,setReason]=useState('');
const[saving,setSaving]=useState(false);
const chain=[];let c=cu;while(c.mid){const m=users.find(x=>x.id===c.mid);if(m){chain.push(m);c=m;}else break;}

const submit=async e=>{
e.preventDefault();
if(!type||!start||!end||reason.length<10)return;
setSaving(true);
const{data,error}=await supabase.from('leaves').insert({user_id:cu.id,type,start_date:start,end_date:end,reason,status:'pending',approver_id:chain[0]?chain[0].id:null,chain:chain.map(x=>x.id)}).select().single();
setSaving(false);
if(!error){
setLeaves(p=>[{id:data.id,uid:cu.id,type,start,end,reason,status:'pending',approver:chain[0]?chain[0].id:null,chain:chain.map(x=>x.id)},...p]);
toast.addToast('success','Talep OluÅŸturuldu','Ä°zin talebiniz onaya gÃ¶nderildi');
setType('');setStart('');setEnd('');setReason('');
}
};

return(
<div>
<div className="page-header"><h1>Ä°zin Talebi</h1><p>Yeni izin talebi oluÅŸturun</p></div>
<div className="card">
<form onSubmit={submit} style={{maxWidth:600}}>
<div className="form-group">
<label className="form-label req">Ä°zin TÃ¼rÃ¼</label>
<div className="leave-type-grid">
{LTYPES.map(t=><div key={t.id} className={`leave-type ${type===t.id?'selected':''}`} onClick={()=>setType(t.id)}><div className="leave-type-icon">{t.icon}</div><h4 style={{color:t.clr}}>{t.name}</h4></div>)}
</div>
</div>
<div className="form-row">
<div className="form-group"><label className="form-label req">BaÅŸlangÄ±Ã§</label><input type="date" value={start} onChange={e=>setStart(e.target.value)}/></div>
<div className="form-group"><label className="form-label req">BitiÅŸ</label><input type="date" value={end} onChange={e=>setEnd(e.target.value)}/></div>
</div>
<div className="form-group"><label className="form-label req">AÃ§Ä±klama (min 10 karakter)</label><textarea value={reason} onChange={e=>setReason(e.target.value)} placeholder="Ä°zin sebebinizi aÃ§Ä±klayÄ±n..."/></div>
<button className="btn btn-primary" disabled={saving||!type||!start||!end||reason.length<10}>{saving?'GÃ¶nderiliyor...':'Talep OluÅŸtur'}</button>
</form>
</div>
</div>
);
}

function LeaveList({cu,leaves,users,setLeaves,canManage}){
const toast=useToast();
const data=canManage?leaves:leaves.filter(x=>x.uid===cu.id);

const approve=async id=>{
const l=leaves.find(x=>x.id===id);
const idx=l.chain.indexOf(l.approver);
const isLast=idx===l.chain.length-1;
const upd=isLast?{status:'approved',approver_id:null}:{approver_id:l.chain[idx+1]};
await supabase.from('leaves').update(upd).eq('id',id);
setLeaves(p=>p.map(x=>x.id===id?(isLast?{...x,status:'approved',approver:null}:{...x,approver:l.chain[idx+1]}):x));
toast.addToast('success','OnaylandÄ±','Ä°zin talebi onaylandÄ±');
};

const reject=async id=>{
await supabase.from('leaves').update({status:'rejected',approver_id:null}).eq('id',id);
setLeaves(p=>p.map(x=>x.id===id?{...x,status:'rejected',approver:null}:x));
toast.addToast('error','Reddedildi','Ä°zin talebi reddedildi');
};

return(
<div>
<div className="page-header"><h1>{canManage?'Ä°zin OnaylarÄ±':'Ä°zinlerim'}</h1></div>
<div className="card">
<table>
<thead><tr>{canManage&&<th>Personel</th>}<th>TÃ¼r</th><th>Tarih AralÄ±ÄŸÄ±</th><th>Durum</th>{canManage&&<th>Ä°ÅŸlem</th>}</tr></thead>
<tbody>{data.map(l=>{
const u=users.find(x=>x.id===l.uid);
const t=LTYPES.find(x=>x.id===l.type);
const canAct=l.approver===cu.id&&l.status==='pending';
return<tr key={l.id}>{canManage&&<td>{u?u.name:''}</td>}<td><span style={{color:t?t.clr:''}}>{t?t.icon:''} {t?t.name:''}</span></td><td>{l.start} â†’ {l.end}</td><td><span className={`badge badge-${l.status}`}>{l.status==='pending'?'Bekliyor':l.status==='approved'?'OnaylandÄ±':'Reddedildi'}</span></td>{canManage&&<td>{canAct&&<><button className="btn btn-success btn-sm" onClick={()=>approve(l.id)}><Icon.Check/>Onayla</button> <button className="btn btn-danger btn-sm" onClick={()=>reject(l.id)}><Icon.X/>Reddet</button></>}</td>}</tr>;
})}</tbody>
</table>
</div>
</div>
);
}

function Users({users,setUsers,companies,roles,isMaster,isAdmin,cu}){
const toast=useToast();
const isGM=cu.role==='gm',isAmir=cu.role==='amir';
const canManage=isMaster||isAdmin||isGM||isAmir;
const canToggle=isMaster||isAdmin;
const[editUser,setEditUser]=useState(null);
const[newUser,setNewUser]=useState(null);
const[filter,setFilter]=useState('all');
const[saving,setSaving]=useState(false);
const staff=users.filter(x=>x.role!=='master');
const filtered=staff.filter(x=>filter==='all'?true:filter==='active'?x.active:!x.active);
const roleOpts=Object.entries(roles).filter(([k])=>!['master','firma_admin'].includes(k));

const toggleActive=async(id,val)=>{
if(!canToggle)return;
await supabase.from('users').update({active:val}).eq('id',id);
setUsers(p=>p.map(x=>x.id===id?{...x,active:val}:x));
toast.addToast(val?'success':'warning',val?'Aktif Edildi':'Pasif Edildi','KullanÄ±cÄ± durumu gÃ¼ncellendi');
};

const saveEdit=async()=>{
if(!canManage)return;
setSaving(true);
await supabase.from('users').update({name:editUser.name,email:editUser.email,role:editUser.role,annual_leave:editUser.annual,used_leave:editUser.used,birth_date:editUser.birthDate,start_date:editUser.startDate,shift:editUser.shift}).eq('id',editUser.id);
setUsers(p=>p.map(x=>x.id===editUser.id?editUser:x));
setEditUser(null);
setSaving(false);
toast.addToast('success','Kaydedildi','KullanÄ±cÄ± bilgileri gÃ¼ncellendi');
};

const openNew=()=>{
if(!canManage)return;
setNewUser({name:'',email:'',pw:'123456',role:'personel',cid:isMaster?companies[0]?.id:cu.cid,annual:14,used:0,birthDate:'',startDate:'',shift:'sabah',active:true,oderId:'PTS-'+String(users.length+1).padStart(4,'0')});
};

const saveNew=async()=>{
if(!newUser.name||!newUser.email||!canManage)return;
setSaving(true);
const{data,error}=await supabase.from('users').insert({order_id:newUser.oderId,name:newUser.name,email:newUser.email,password:newUser.pw,role:newUser.role,company_id:newUser.cid,annual_leave:newUser.annual,used_leave:newUser.used,birth_date:newUser.birthDate,start_date:newUser.startDate,shift:newUser.shift,active:true}).select().single();
setSaving(false);
if(!error){
setUsers(p=>[{...newUser,id:data.id},...p]);
setNewUser(null);
toast.addToast('success','Eklendi','Yeni kullanÄ±cÄ± oluÅŸturuldu');
}
};

return(
<div>
<div className="page-header">
<h1>Personeller</h1>
<p>KullanÄ±cÄ± yÃ¶netimi</p>
<div className="page-actions">
<button className={`btn btn-sm ${filter==='all'?'btn-primary':'btn-ghost'}`} onClick={()=>setFilter('all')}>TÃ¼mÃ¼</button>
<button className={`btn btn-sm ${filter==='active'?'btn-success':'btn-ghost'}`} onClick={()=>setFilter('active')}>Aktif</button>
<button className={`btn btn-sm ${filter==='passive'?'btn-danger':'btn-ghost'}`} onClick={()=>setFilter('passive')}>Pasif</button>
<button className="btn btn-primary btn-sm" onClick={openNew}><Icon.Plus/>Yeni Ekle</button>
</div>
</div>
<div className="card">
<table>
<thead><tr><th>Sicil</th>{isMaster&&<th>Firma</th>}<th>Personel</th><th>Rol</th><th>Vardiya</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
<tbody>{filtered.map(u=>{
const c=companies.find(x=>x.id===u.cid);
const sh=SHIFTS.find(x=>x.id===u.shift);
return<tr key={u.id} style={{opacity:u.active?1:0.5}}>
<td><span className="user-id">{u.oderId}</span></td>
{isMaster&&<td style={{fontSize:12}}>{c?c.name:'-'}</td>}
<td><b>{u.name}</b><br/><span style={{fontSize:11,color:'var(--muted)'}}>{u.email}</span></td>
<td><span className="badge badge-approved">{roles[u.role]||u.role}</span></td>
<td>{sh?`${sh.icon} ${sh.name}`:'-'}</td>
<td><span className={`badge badge-${u.active?'active':'passive'}`}>{u.active?'Aktif':'Pasif'}</span></td>
<td style={{display:'flex',gap:6,alignItems:'center'}}>
<button className="btn btn-ghost btn-sm" onClick={()=>setEditUser({...u})}><Icon.Edit/></button>
{canToggle&&!['master','firma_admin'].includes(u.role)&&<label className="toggle"><input type="checkbox" checked={u.active} onChange={e=>toggleActive(u.id,e.target.checked)}/><span></span></label>}
</td>
</tr>;})}</tbody>
</table>
</div>

{editUser&&<div className="modal-overlay" onClick={()=>setEditUser(null)}><div className="modal" onClick={e=>e.stopPropagation()}>
<div className="modal-header"><h2>KullanÄ±cÄ± DÃ¼zenle</h2><button className="modal-close" onClick={()=>setEditUser(null)}><Icon.X/></button></div>
<div className="modal-body">
<div className="form-group"><label className="form-label">Ad Soyad</label><input value={editUser.name} onChange={e=>setEditUser({...editUser,name:e.target.value})}/></div>
<div className="form-group"><label className="form-label">E-posta</label><input value={editUser.email} onChange={e=>setEditUser({...editUser,email:e.target.value})}/></div>
<div className="form-row">
<div className="form-group"><label className="form-label">DoÄŸum Tarihi</label><input value={editUser.birthDate||''} onChange={e=>setEditUser({...editUser,birthDate:e.target.value})} placeholder="GG.AA.YYYY"/></div>
<div className="form-group"><label className="form-label">Ä°ÅŸe GiriÅŸ</label><input value={editUser.startDate||''} onChange={e=>setEditUser({...editUser,startDate:e.target.value})} placeholder="GG.AA.YYYY"/></div>
</div>
<div className="form-row">
<div className="form-group"><label className="form-label">Rol</label><select value={editUser.role} onChange={e=>setEditUser({...editUser,role:e.target.value})}>{roleOpts.map(([k,v])=><option key={k} value={k}>{v}</option>)}</select></div>
<div className="form-group"><label className="form-label">Vardiya</label><select value={editUser.shift||'sabah'} onChange={e=>setEditUser({...editUser,shift:e.target.value})}>{SHIFTS.map(s=><option key={s.id} value={s.id}>{s.icon} {s.name}</option>)}</select></div>
</div>
<div className="form-row">
<div className="form-group"><label className="form-label">YÄ±llÄ±k Ä°zin</label><input type="number" value={editUser.annual} onChange={e=>setEditUser({...editUser,annual:+e.target.value})}/></div>
<div className="form-group"><label className="form-label">KullanÄ±lan</label><input type="number" value={editUser.used} onChange={e=>setEditUser({...editUser,used:+e.target.value})}/></div>
</div>
</div>
<div className="modal-footer"><button className="btn btn-ghost" onClick={()=>setEditUser(null)}>Ä°ptal</button><button className="btn btn-primary" onClick={saveEdit} disabled={saving}>{saving?'...':'Kaydet'}</button></div>
</div></div>}

{newUser&&<div className="modal-overlay" onClick={()=>setNewUser(null)}><div className="modal" onClick={e=>e.stopPropagation()}>
<div className="modal-header"><h2>Yeni KullanÄ±cÄ±</h2><button className="modal-close" onClick={()=>setNewUser(null)}><Icon.X/></button></div>
<div className="modal-body">
<p style={{marginBottom:16}}>Sicil No: <span className="user-id">{newUser.oderId}</span></p>
<div className="form-row">
<div className="form-group"><label className="form-label req">Ad Soyad</label><input value={newUser.name} onChange={e=>setNewUser({...newUser,name:e.target.value})}/></div>
<div className="form-group"><label className="form-label req">E-posta</label><input value={newUser.email} onChange={e=>setNewUser({...newUser,email:e.target.value})}/></div>
</div>
<div className="form-row">
<div className="form-group"><label className="form-label">DoÄŸum Tarihi</label><input value={newUser.birthDate} onChange={e=>setNewUser({...newUser,birthDate:e.target.value})} placeholder="GG.AA.YYYY"/></div>
<div className="form-group"><label className="form-label">Ä°ÅŸe GiriÅŸ</label><input value={newUser.startDate} onChange={e=>setNewUser({...newUser,startDate:e.target.value})} placeholder="GG.AA.YYYY"/></div>
</div>
{isMaster&&<div className="form-group"><label className="form-label">Firma</label><select value={newUser.cid||''} onChange={e=>setNewUser({...newUser,cid:e.target.value})}>{companies.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>}
<div className="form-row">
<div className="form-group"><label className="form-label">Rol</label><select value={newUser.role} onChange={e=>setNewUser({...newUser,role:e.target.value})}>{roleOpts.map(([k,v])=><option key={k} value={k}>{v}</option>)}</select></div>
<div className="form-group"><label className="form-label">Vardiya</label><select value={newUser.shift} onChange={e=>setNewUser({...newUser,shift:e.target.value})}>{SHIFTS.map(s=><option key={s.id} value={s.id}>{s.icon} {s.name}</option>)}</select></div>
</div>
<div className="form-row">
<div className="form-group"><label className="form-label">YÄ±llÄ±k Ä°zin</label><input type="number" value={newUser.annual} onChange={e=>setNewUser({...newUser,annual:+e.target.value})}/></div>
<div className="form-group"><label className="form-label">Åžifre</label><input value={newUser.pw} onChange={e=>setNewUser({...newUser,pw:e.target.value})}/></div>
</div>
</div>
<div className="modal-footer"><button className="btn btn-ghost" onClick={()=>setNewUser(null)}>Ä°ptal</button><button className="btn btn-success" onClick={saveNew} disabled={saving}>{saving?'...':'Ekle'}</button></div>
</div></div>}
</div>
);
}

function Companies({companies,setCompanies,users}){
const toast=useToast();
const[modal,setModal]=useState(null);
const[editComp,setEditComp]=useState(null);
const[newComp,setNewComp]=useState(null);
const[saving,setSaving]=useState(false);
const getCount=(cid,a)=>users.filter(x=>x.cid===cid&&x.active===a&&!['master','firma_admin'].includes(x.role)).length;

const toggleActive=async(id,val)=>{
await supabase.from('companies').update({active:val}).eq('id',id);
setCompanies(p=>p.map(x=>x.id===id?{...x,active:val}:x));
toast.addToast(val?'success':'warning',val?'Firma Aktif':'Firma Pasif','Durum gÃ¼ncellendi');
};

const openNew=()=>setNewComp({name:'',locReq:false,lat:41.01,lng:28.97,radius:200,dailyMin:540,active:true});

const saveNew=async()=>{
if(!newComp.name.trim())return;
setSaving(true);
const qr='PTS-'+newComp.name.substring(0,3).toUpperCase()+'-'+Date.now().toString(36).toUpperCase();
const{data,error}=await supabase.from('companies').insert({name:newComp.name,qr,loc_req:newComp.locReq,lat:newComp.lat,lng:newComp.lng,radius:newComp.radius,daily_min:newComp.dailyMin,active:true}).select().single();
setSaving(false);
if(!error){
setCompanies(p=>[{id:data.id,name:newComp.name,qr,locReq:newComp.locReq,lat:newComp.lat,lng:newComp.lng,radius:newComp.radius,dailyMin:newComp.dailyMin,active:true},...p]);
setNewComp(null);
toast.addToast('success','Firma Eklendi','Yeni firma baÅŸarÄ±yla oluÅŸturuldu');
}
};

const saveEdit=async()=>{
if(!editComp.name.trim())return;
setSaving(true);
await supabase.from('companies').update({name:editComp.name,loc_req:editComp.locReq,lat:editComp.lat,lng:editComp.lng,radius:editComp.radius,daily_min:editComp.dailyMin}).eq('id',editComp.id);
setCompanies(p=>p.map(x=>x.id===editComp.id?{...x,name:editComp.name,locReq:editComp.locReq,lat:editComp.lat,lng:editComp.lng,radius:editComp.radius,dailyMin:editComp.dailyMin}:x));
setEditComp(null);
setSaving(false);
toast.addToast('success','Kaydedildi','Firma bilgileri gÃ¼ncellendi');
};

return(
<div>
<div className="page-header">
<h1>Firmalar</h1>
<p>Firma yÃ¶netimi</p>
<div className="page-actions"><button className="btn btn-primary btn-sm" onClick={openNew}><Icon.Plus/>Yeni Firma</button></div>
</div>
<div className="card">
<table>
<thead><tr><th>Firma</th><th>Aktif</th><th>Pasif</th><th>Konum</th><th>Durum</th><th>AÃ§/Kapa</th><th>Ä°ÅŸlem</th></tr></thead>
<tbody>{companies.map(c=><tr key={c.id} style={{opacity:c.active?1:0.5}}>
<td><b>{c.name}</b><br/><span style={{fontSize:11,color:'var(--muted)'}}>{c.qr}</span></td>
<td style={{color:'var(--success)'}}>{getCount(c.id,true)}</td>
<td style={{color:'var(--danger)'}}>{getCount(c.id,false)}</td>
<td><span className={`badge badge-${c.locReq?'approved':'pending'}`}>{c.locReq?'AÃ§Ä±k':'KapalÄ±'}</span></td>
<td><span className={`badge badge-${c.active?'active':'passive'}`}>{c.active?'Aktif':'Pasif'}</span></td>
<td><label className="toggle"><input type="checkbox" checked={c.active} onChange={e=>toggleActive(c.id,e.target.checked)}/><span></span></label></td>
<td style={{display:'flex',gap:6}}><button className="btn btn-ghost btn-sm" onClick={()=>setEditComp({...c})}><Icon.Edit/></button><button className="btn btn-sm" style={{background:'var(--info)',color:'#000'}} onClick={()=>setModal(c)}><Icon.QR/></button></td>
</tr>)}</tbody>
</table>
</div>

{modal&&<div className="modal-overlay" onClick={()=>setModal(null)}><div className="modal" onClick={e=>e.stopPropagation()}>
<div className="modal-header"><h2>{modal.name} - QR Kodu</h2><button className="modal-close" onClick={()=>setModal(null)}><Icon.X/></button></div>
<div className="modal-body" style={{textAlign:'center'}}>
<div className="qr-preview">
<h3>{modal.name}</h3>
<img src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(modal.qr)}`} alt="QR"/>
<p>{modal.qr}</p>
</div>
</div>
<div className="modal-footer"><button className="btn btn-ghost" onClick={()=>setModal(null)}>Kapat</button><button className="btn btn-primary" onClick={()=>window.print()}><Icon.Print/>YazdÄ±r</button></div>
</div></div>}

{editComp&&<div className="modal-overlay" onClick={()=>setEditComp(null)}><div className="modal" onClick={e=>e.stopPropagation()}>
<div className="modal-header"><h2>Firma DÃ¼zenle</h2><button className="modal-close" onClick={()=>setEditComp(null)}><Icon.X/></button></div>
<div className="modal-body">
<div className="form-group"><label className="form-label req">Firma AdÄ±</label><input value={editComp.name} onChange={e=>setEditComp({...editComp,name:e.target.value})}/></div>
<div className="form-group"><label className="form-label">QR Kodu</label><input value={editComp.qr} disabled style={{opacity:0.6}}/></div>
<div className="form-row">
<div className="form-group"><label className="form-label">Enlem</label><input type="number" step="0.0001" value={editComp.lat} onChange={e=>setEditComp({...editComp,lat:+e.target.value})}/></div>
<div className="form-group"><label className="form-label">Boylam</label><input type="number" step="0.0001" value={editComp.lng} onChange={e=>setEditComp({...editComp,lng:+e.target.value})}/></div>
</div>
<div className="form-row">
<div className="form-group"><label className="form-label">YarÄ±Ã§ap (m)</label><input type="number" value={editComp.radius} onChange={e=>setEditComp({...editComp,radius:+e.target.value})}/></div>
<div className="form-group"><label className="form-label">GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma (dk)</label><input type="number" value={editComp.dailyMin} onChange={e=>setEditComp({...editComp,dailyMin:+e.target.value})}/></div>
</div>
<div className="setting-item"><div className="setting-info"><h4>Konum KontrolÃ¼</h4><p>QR okutmada konum doÄŸrulama</p></div><label className="toggle"><input type="checkbox" checked={editComp.locReq} onChange={e=>setEditComp({...editComp,locReq:e.target.checked})}/><span></span></label></div>
</div>
<div className="modal-footer"><button className="btn btn-ghost" onClick={()=>setEditComp(null)}>Ä°ptal</button><button className="btn btn-primary" onClick={saveEdit} disabled={saving}>{saving?'...':'Kaydet'}</button></div>
</div></div>}

{newComp&&<div className="modal-overlay" onClick={()=>setNewComp(null)}><div className="modal" onClick={e=>e.stopPropagation()}>
<div className="modal-header"><h2>Yeni Firma</h2><button className="modal-close" onClick={()=>setNewComp(null)}><Icon.X/></button></div>
<div className="modal-body">
<div className="form-group"><label className="form-label req">Firma AdÄ±</label><input value={newComp.name} onChange={e=>setNewComp({...newComp,name:e.target.value})}/></div>
<div className="form-row">
<div className="form-group"><label className="form-label">Enlem</label><input type="number" step="0.0001" value={newComp.lat} onChange={e=>setNewComp({...newComp,lat:+e.target.value})}/></div>
<div className="form-group"><label className="form-label">Boylam</label><input type="number" step="0.0001" value={newComp.lng} onChange={e=>setNewComp({...newComp,lng:+e.target.value})}/></div>
</div>
<div className="form-row">
<div className="form-group"><label className="form-label">YarÄ±Ã§ap (m)</label><input type="number" value={newComp.radius} onChange={e=>setNewComp({...newComp,radius:+e.target.value})}/></div>
<div className="form-group"><label className="form-label">GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma (dk)</label><input type="number" value={newComp.dailyMin} onChange={e=>setNewComp({...newComp,dailyMin:+e.target.value})}/></div>
</div>
<div className="setting-item"><div className="setting-info"><h4>Konum KontrolÃ¼</h4><p>QR okutmada konum doÄŸrulama</p></div><label className="toggle"><input type="checkbox" checked={newComp.locReq} onChange={e=>setNewComp({...newComp,locReq:e.target.checked})}/><span></span></label></div>
</div>
<div className="modal-footer"><button className="btn btn-ghost" onClick={()=>setNewComp(null)}>Ä°ptal</button><button className="btn btn-success" onClick={saveNew} disabled={saving}>{saving?'...':'Ekle'}</button></div>
</div></div>}
</div>
);
}

function Roles({roles,setRoles}){
const toast=useToast();
const[newRole,setNewRole]=useState({id:'',name:''});
const[saving,setSaving]=useState(false);
const sysRoles=['master','firma_admin','gm','amir','personel'];

const add=async()=>{
if(!newRole.id||!newRole.name||roles[newRole.id])return;
setSaving(true);
await supabase.from('roles').insert({id:newRole.id,name:newRole.name,is_system:false});
setRoles({...roles,[newRole.id]:newRole.name});
setNewRole({id:'',name:''});
setSaving(false);
toast.addToast('success','Rol Eklendi','Yeni rol baÅŸarÄ±yla oluÅŸturuldu');
};

const del=async id=>{
if(sysRoles.includes(id))return;
await supabase.from('roles').delete().eq('id',id);
const n={};Object.keys(roles).forEach(k=>{if(k!==id)n[k]=roles[k];});
setRoles(n);
toast.addToast('warning','Rol Silindi','Rol baÅŸarÄ±yla kaldÄ±rÄ±ldÄ±');
};

return(
<div>
<div className="page-header"><h1>Roller</h1><p>Yetki rolleri yÃ¶netimi</p></div>
<div className="card">
<div className="card-title">Yeni Rol Ekle</div>
<div style={{display:'flex',gap:12,flexWrap:'wrap',alignItems:'flex-end'}}>
<div className="form-group" style={{margin:0,flex:1,minWidth:120}}><label className="form-label">ID (kÃ¼Ã§Ã¼k harf)</label><input value={newRole.id} onChange={e=>setNewRole({id:e.target.value.toLowerCase().replace(/\s/g,'_'),name:newRole.name})}/></div>
<div className="form-group" style={{margin:0,flex:1,minWidth:120}}><label className="form-label">GÃ¶rÃ¼nen Ad</label><input value={newRole.name} onChange={e=>setNewRole({...newRole,name:e.target.value})}/></div>
<button className="btn btn-success btn-sm" onClick={add} disabled={saving||!newRole.id||!newRole.name}><Icon.Plus/>Ekle</button>
</div>
</div>
<div className="card">
<table>
<thead><tr><th>ID</th><th>Ad</th><th>Tip</th><th>Ä°ÅŸlem</th></tr></thead>
<tbody>{Object.keys(roles).map(id=><tr key={id}>
<td><span className="user-id">{id}</span></td>
<td>{roles[id]}</td>
<td><span className={`badge ${sysRoles.includes(id)?'badge-pending':'badge-approved'}`}>{sysRoles.includes(id)?'Sistem':'Ã–zel'}</span></td>
<td>{!sysRoles.includes(id)&&<button className="btn btn-danger btn-sm" onClick={()=>del(id)}>Sil</button>}</td>
</tr>)}</tbody>
</table>
</div>
</div>
);
}

function MyCompany({comp,setCompanies}){
const toast=useToast();
const[saving,setSaving]=useState(false);

const regen=async()=>{
if(!comp)return;
const nq='PTS-'+comp.name.substring(0,3).toUpperCase()+'-'+Date.now().toString(36).toUpperCase();
setSaving(true);
await supabase.from('companies').update({qr:nq}).eq('id',comp.id);
setCompanies(p=>p.map(x=>x.id===comp.id?{...x,qr:nq}:x));
setSaving(false);
toast.addToast('warning','QR Yenilendi','Eski QR kodlarÄ± artÄ±k geÃ§ersiz!');
};

if(!comp)return<div><div className="page-header"><h1>Firma QR</h1></div><div className="card"><p style={{color:'var(--muted)'}}>Firma bilgisi bulunamadÄ±</p></div></div>;

return(
<div>
<div className="page-header"><h1>Firma QR Kodu</h1><p>{comp.name}</p></div>
<div className="card" style={{textAlign:'center'}}>
<div className="qr-preview">
<h3>{comp.name}</h3>
<img src={`https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(comp.qr)}`} alt="QR"/>
<p>{comp.qr}</p>
</div>
<div style={{display:'flex',gap:10,justifyContent:'center',marginTop:16}}>
<button className="btn btn-primary btn-sm" onClick={()=>window.print()}><Icon.Print/>YazdÄ±r</button>
<button className="btn btn-danger btn-sm" onClick={regen} disabled={saving}><Icon.QR/>{saving?'...':'QR Yenile'}</button>
</div>
<p style={{fontSize:12,color:'var(--muted)',marginTop:16}}>âš ï¸ QR yenilenirse eski kodlar Ã§alÄ±ÅŸmaz!</p>
</div>
</div>
);
}

function Settings({companies,setCompanies}){
const toast=useToast();

const toggle=async(id,val)=>{
await supabase.from('companies').update({loc_req:val}).eq('id',id);
setCompanies(p=>p.map(x=>x.id===id?{...x,locReq:val}:x));
toast.addToast('info','Ayar GÃ¼ncellendi',val?'Konum kontrolÃ¼ aÃ§Ä±ldÄ±':'Konum kontrolÃ¼ kapatÄ±ldÄ±');
};

return(
<div>
<div className="page-header"><h1>Ayarlar</h1><p>Sistem ayarlarÄ±</p></div>
<div className="card">
<div className="card-title">Konum DoÄŸrulama</div>
{companies.map(c=><div className="setting-item" key={c.id}>
<div className="setting-info"><h4>{c.name}</h4><p>{c.locReq?'Konum kontrolÃ¼ aktif':'Konum kontrolÃ¼ kapalÄ±'}</p></div>
<label className="toggle"><input type="checkbox" checked={c.locReq} onChange={e=>toggle(c.id,e.target.checked)}/><span></span></label>
</div>)}
</div>
<div className="card">
<div className="card-title">PWA Kurulumu</div>
<div className="setting-item">
<div className="setting-info"><h4>Telefona Kur</h4><p>UygulamayÄ± ana ekranÄ±nÄ±za ekleyin</p></div>
<button className="btn btn-primary btn-sm" onClick={()=>toast.addToast('info','PWA','TarayÄ±cÄ± menÃ¼sÃ¼nden "Ana Ekrana Ekle" seÃ§in')}>NasÄ±l?</button>
</div>
</div>
</div>
);
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
